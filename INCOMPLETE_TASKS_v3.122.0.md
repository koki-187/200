# 未完了タスク一覧 - v3.122.0 デバッグ版

## 📅 更新日：2025-12-04 (v3.122.0)

## ✅ v3.122.0で完了したタスク

1. **OCRデバッグログの大幅強化** ✅
   - 各フィールドの詳細な値をJSON.stringify()で表示
   - フィールド処理時の詳細ログ
   - エラー検出ログ（DOM要素不在、データ不在等）
   
2. **建蔽率・容積率フィールドの実装確認** ✅
   - フォームフィールドID確認: `building_coverage`, `floor_area_ratio`
   - ocr-init.jsの処理コード確認
   - **結論**: フロントエンドコードは完全に正しい

3. **引き継ぎ資料作成** ✅
   - HANDOVER_v3.122.0_DEBUG.md
   - 詳細な問題分析
   - 診断手順とケース別対応策

## ⏳ 現在未完了のタスク

### 🔴 優先度：最高（ユーザーアクション必須）

#### 1. ユーザーによる詳細ログ確認テスト
**担当**: ユーザー様
**URL**: https://82c2745b.real-estate-200units-v2.pages.dev/deals/new
**アカウント**: navigator-187@docomo.ne.jp / kouki187

**テスト手順**:
1. 同じPDFファイル（物件概要_page1.png）を再度アップロード
2. OCR処理完了後、F12キーでブラウザコンソールを開く
3. 以下のログを探す：
   ```
   [OCR] 🔍 DETAILED FIELD VALUES:
   [OCR] property_name: {"value": ?, "confidence": ?}
   [OCR] building_coverage: {"value": ?, "confidence": ?}
   [OCR] floor_area_ratio: {"value": ?, "confidence": ?}
   ```
4. **このログのスクリーンショットを撮影して報告**

**期待される情報**:
- `"value": null` → OpenAI API抽出失敗
- `"value": ""` → 空文字列（データ正規化の問題）
- `"value": "実際の値"` → フロントエンド表示の問題

**期限**: 次のチャット開始前（最優先）

**重要性**: ★★★★★
このテスト結果により、次の修正方針が決定します。

---

### 🔴 優先度：高（診断結果待ち）

#### 2. OCR抽出精度の改善
**現状**: 一部フィールド（property_name, station, land_area等）が空
**診断待ち**: ユーザーテスト結果により修正方針決定

**パターンA対応** (value が null の場合):
- [ ] PROPERTY_EXTRACTION_PROMPTの改善
- [ ] より詳細なフィールド説明の追加
- [ ] 建蔽率・容積率の明示的な抽出指示

**パターンB対応** (value が空文字列の場合):
- [ ] normalizePropertyData関数の修正
- [ ] 空文字列を null として扱うロジック追加

**パターンC対応** (value に値があるが表示されない場合):
- [ ] getFieldValue関数の再検証
- [ ] DOM操作の確認
- [ ] フィールドIDの再確認

**期限**: ユーザーテスト結果受領後、即座に着手

---

#### 3. OCR抽出ロジックの最適化
**必要に応じて実施**

**実装候補**:
- [ ] gpt-4o-visionモデルへのアップグレード（現在: gpt-4o）
- [ ] PDF前処理の追加（画質改善、テキスト抽出最適化）
- [ ] セマンティック検索による情報補完
- [ ] 複数回の抽出試行とマージ

**期限**: OCR抽出精度改善後

---

### 🟡 優先度：中（OCR修正後に着手）

#### 4. Invalid or unexpected tokenエラーの根本解決
**現状**: ブラウザで構文エラーが発生（OCR機能には影響なし）
**原因**: src/index.tsx（12,057行）内の動的コンテンツ

**対応方法**:
- [ ] ブラウザ開発者ツールで正確なエラー位置を特定
- [ ] 該当箇所のテンプレートリテラルを修正
- [ ] src/index.tsxのモジュール化を検討

**期限**: OCR問題解決後

---

#### 5. 金融機関NG項目の入力フォームUI実装
**現状**: データモデルのみ実装済み（Migration完了）

**実装項目**:
- [ ] がけ地・火災危険地域（cliff_fire_area）チェックボックス
- [ ] 浸水深（flood_depth_m）数値入力
- [ ] ハザードマップ種別（hazard_map_category）複数選択
- [ ] 河川隣接（river_adjacent）チェックボックス
- [ ] 家屋倒壊等氾濫想定区域（house_collapse_zone）チェックボックス

**UI実装箇所**: `/deals/new` ページ

**期限**: OCR問題解決後

---

#### 6. 金融機関NG項目の判定ロジック実装
**現状**: 未実装

**実装内容**:
- [ ] RiskEvaluatorクラスの作成
- [ ] 各NG項目のチェックロジック
- [ ] 総合判定ロジック（isNG, reasons配列）
- [ ] 既存リスク評価ロジックとの統合

**実装箇所**: `src/lib/risk-evaluator.ts`（新規作成）

**期限**: UI実装後

---

#### 7. 金融機関NG項目のハザードマップAPI自動取得
**現状**: 未実装

**実装内容**:
- [ ] 住所から緯度経度を取得
- [ ] 国土交通省「重ねるハザードマップ」API連携
- [ ] 河川隣接（50m以内）判定
- [ ] 取得失敗時の手動入力フォールバック

**API**: MLIT_API_KEY（ユーザー報告では連携済み）

**期限**: 判定ロジック実装後

---

#### 8. 金融機関NG項目のUIバッジ表示
**現状**: 未実装

**実装内容**:
- [ ] 物件一覧カードに「金融機関NG」バッジ（赤色）
- [ ] 物件詳細画面に「金融機関評価」パネル
- [ ] NG項目の詳細表示
- [ ] NG物件のフィルタリング機能

**期限**: 判定ロジック実装後

---

### 🟢 優先度：低（長期的な改善）

#### 9. src/index.tsxのモジュール化
**現状**: 単一ファイル12,057行
**問題**: メンテナンス性が低い、ビルド時間が長い

**期限**: 低優先度

---

#### 10. ビルドプロセスの最適化
**現状**: ビルドに4秒、タイムアウトリスクあり

**期限**: 低優先度

---

## 📊 完成度サマリー

### 現在の推定完成度: **75%**

**内訳**:
- フロントエンド実装: 100% ✅
- バックエンド実装: 100% ✅
- OCR抽出精度: 50% ⚠️（location成功、他失敗）
- 統合テスト: 0% ❌（ユーザーテスト待ち）
- 金融機関NG項目: 20% ⚠️（データモデルのみ）

### 120%完成への道筋

1. **ユーザー詳細ログ確認** → 80%
2. **根本原因特定** → 85%
3. **OCR抽出精度改善** → 95%
4. **全フィールド正常動作確認** → 100%
5. **エラーハンドリング改善** → 110%
6. **金融機関NG項目完全実装** → 120%

## 🎯 即座に必要なアクション

### ユーザー様へ
1. **最優先**: 新しいデプロイ版でOCRテスト実施
   - URL: https://82c2745b.real-estate-200units-v2.pages.dev/deals/new
   - 同じPDFをアップロード
   - F12でコンソールを開く
   - `🔍 DETAILED FIELD VALUES`ログのスクリーンショットを撮影

2. **報告内容**:
   - 各フィールドの`{"value": ?, "confidence": ?}`の実際の値
   - 特に重要: property_name, building_coverage, floor_area_ratio

### 次のチャット担当者へ
1. **ユーザーからのスクリーンショット受領**
2. **パターン判定**（A/B/C）
3. **対応策の即座実施**
4. **修正版のビルド・デプロイ**
5. **再テストの依頼**

## 📁 重要なファイル

### 最新の修正ファイル
- `/home/user/webapp/public/static/ocr-init.js`
  - Line 362-410: 詳細デバッグログ

### 確認済みファイル（問題なし）
- `/home/user/webapp/src/index.tsx`
  - building_coverage, floor_area_ratio フィールド存在確認済み
- `/home/user/webapp/src/routes/ocr-jobs.ts`
  - PROPERTY_EXTRACTION_PROMPT（Line 590-642）
  - normalizePropertyData（Line 648-697）

## 🔗 関連リンク

- **最新本番環境**: https://82c2745b.real-estate-200units-v2.pages.dev
- **テストページ**: https://82c2745b.real-estate-200units-v2.pages.dev/deals/new
- **Git Commit**: 5194373

---
**作成日**: 2025-12-04
**バージョン**: v3.122.0
**次回優先タスク**: ユーザー詳細ログ確認 → 根本原因特定 → 修正実装
