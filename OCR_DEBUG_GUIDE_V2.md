# OCR機能デバッグガイド v2

## 🎯 目的
OCR機能が動作しない原因を特定するため、ユーザー側で以下の手順を実行してください。

## 📋 デバッグ手順

### ステップ1: ブラウザキャッシュのクリア（必須）

**重要**: 古いJavaScriptファイルがキャッシュされている可能性があります。

1. ブラウザで **F12キー** を押して開発者ツールを開く
2. **Network（ネットワーク）** タブを選択
3. 左上の **"Disable cache"（キャッシュを無効化）** にチェックを入れる
4. ページを **Ctrl+Shift+R**（Mac: Cmd+Shift+R）で強制リロード

または

1. ブラウザの設定を開く
2. **履歴とキャッシュをクリア** を選択
3. **すべてのキャッシュをクリア** を実行
4. ページをリロード

### ステップ2: 再ログイン

1. ログアウトボタンをクリック
2. 以下の認証情報で再ログイン：
   - **Email**: `navigator-187@docomo.ne.jp`
   - **Password**: `kouki187`

### ステップ3: コンソールログの確認

1. **F12キー** で開発者ツールを開く
2. **Console（コンソール）** タブを選択
3. `/deals/new` ページに移動
4. コンソールに以下のメッセージが表示されることを確認：

```
[Event Delegation] Initializing event delegation
[Event Delegation] Event delegation setup complete
[Event Delegation] Drop zone initialized
[Event Delegation] Initialization complete
```

5. もし表示されない場合は、**エラーメッセージをスクリーンショット**

### ステップ4: OCRボタンをクリック

1. **"📄 ファイルを選択"** ボタンをクリック
2. コンソールに以下のメッセージが表示されるか確認：

```
[Event Delegation] File input changed
[Event Delegation] Files selected: X
[OCR] ========================================
[OCR] OCR処理開始
[OCR] ファイル数: X
```

3. メッセージが表示されない場合は、**スクリーンショット**

### ステップ5: ファイルを選択

1. 画像ファイル（JPG, PNG）またはPDFファイルを選択
2. コンソールに以下のメッセージが表示されるか確認：

```
[OCR] PDFファイル: X 個
[OCR] 画像ファイル: X 個
[OCR] ✅ ジョブ作成成功 - Job ID: XXXXXXXX
```

3. エラーが表示される場合は、**エラーメッセージ全体をコピー**

### ステップ6: エラーが出る場合の確認

もしエラーが表示される場合は、以下を確認：

1. **認証エラー (401)** の場合：
   - ログアウトして再ログイン
   - 認証トークンが期限切れの可能性

2. **API エラー (500, 502)** の場合：
   - サーバー側の問題の可能性
   - エラーメッセージ全体をコピー

3. **ファイルサイズエラー** の場合：
   - ファイルサイズが10MBを超えていないか確認

4. **ファイル数エラー** の場合：
   - 一度に10個以下のファイルを選択

## 📸 必要な情報

以下の情報を収集してください：

1. **ブラウザのコンソールログ** （F12 → Console タブ）
2. **ネットワークタブのエラー** （F12 → Network タブで `/api/ocr-jobs` を検索）
3. **スクリーンショット** （エラーメッセージが表示される場合）

## 🔧 よくある問題と解決策

### 問題1: ボタンをクリックしても反応しない

**原因**: ブラウザキャッシュまたはJavaScriptの読み込みエラー

**解決策**:
1. Ctrl+Shift+R で強制リロード
2. ブラウザのキャッシュをクリア
3. 別のブラウザで試す（Chrome, Edge, Firefox）

### 問題2: ファイル選択ダイアログが開かない

**原因**: イベントリスナーが正しく登録されていない

**解決策**:
1. コンソールで以下を実行：
```javascript
document.getElementById('ocr-file-input')
```
2. 結果が `null` の場合は、ページが正しく読み込まれていない

### 問題3: "OCR処理開始" が表示されない

**原因**: `processMultipleOCR` 関数が定義されていない

**解決策**:
1. コンソールで以下を実行：
```javascript
typeof processMultipleOCR
```
2. 結果が `"undefined"` の場合は、JavaScriptファイルの読み込みエラー

### 問題4: API エラー (401 Unauthorized)

**原因**: 認証トークンが無効または期限切れ

**解決策**:
1. ログアウトして再ログイン
2. コンソールで以下を実行して確認：
```javascript
localStorage.getItem('auth_token')
```

### 問題5: API エラー (500 Internal Server Error)

**原因**: サーバー側の問題（OpenAI APIキーなど）

**解決策**:
1. ネットワークタブで `/api/ocr-jobs` のレスポンスを確認
2. エラーメッセージ全体をコピー

## ✅ 正常動作時の流れ

1. ボタンクリック → ファイル選択ダイアログが開く
2. ファイル選択 → "OCR処理開始" が表示される
3. 画像プレビューが表示される
4. プログレスバーが進行する (0% → 100%)
5. OCR結果が表示される（16項目）
6. "案件フォームに反映" ボタンが表示される

## 📊 期待される処理時間

- **ジョブ作成**: < 1秒
- **OCR処理**: 10〜20秒（ファイル数による）
- **結果表示**: < 1秒

## 🆘 問題が解決しない場合

以下の情報を提供してください：

1. ブラウザ名とバージョン（例: Chrome 120.0.6099.109）
2. OS（Windows 10/11, macOS, Android, iOS）
3. コンソールログ全体のスクリーンショット
4. ネットワークタブのエラー（特に `/api/ocr-jobs` のレスポンス）
5. 使用したファイルの種類とサイズ

---

**最終更新**: 2025-11-26  
**バージョン**: v3.50.3  
**本番URL**: https://real-estate-200units-v2.pages.dev
