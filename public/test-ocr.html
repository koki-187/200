<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR Test Page - Standalone</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">OCR機能テストページ</h1>
    
    <div class="mb-8">
      <label class="block text-sm font-medium text-gray-700 mb-2">認証トークン</label>
      <input type="text" id="authToken" placeholder="Bearer トークンを入力" 
        class="w-full px-4 py-2 border border-gray-300 rounded-md">
      <p class="text-xs text-gray-500 mt-1">
        ログイン後、localStorage.getItem('auth_token') で取得できます
      </p>
    </div>

    <div class="mb-8">
      <label class="block text-sm font-medium text-gray-700 mb-2">テストファイル</label>
      <input type="file" id="testFile" accept="image/*,.pdf" multiple
        class="w-full px-4 py-2 border border-gray-300 rounded-md">
    </div>

    <button id="startOCR" 
      class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 font-medium">
      OCR処理を開始
    </button>

    <div id="progress" class="hidden mt-8">
      <div class="mb-2">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span id="progressText">処理中...</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div id="results" class="mt-8 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">抽出結果</h2>
      <div id="resultsContent" class="space-y-4"></div>
    </div>

    <div id="error" class="mt-8 hidden">
      <div class="bg-red-50 border border-red-200 rounded-md p-4">
        <h3 class="text-red-800 font-medium mb-2">エラーが発生しました</h3>
        <pre id="errorContent" class="text-sm text-red-700 whitespace-pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
    const startBtn = document.getElementById('startOCR');
    const authTokenInput = document.getElementById('authToken');
    const testFileInput = document.getElementById('testFile');
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    const errorDiv = document.getElementById('error');
    const errorContent = document.getElementById('errorContent');

    startBtn.addEventListener('click', async () => {
      const token = authTokenInput.value.trim();
      const files = testFileInput.files;

      if (!token) {
        alert('認証トークンを入力してください');
        return;
      }

      if (files.length === 0) {
        alert('ファイルを選択してください');
        return;
      }

      // Hide previous results/errors
      resultsDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      progressDiv.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = 'ファイルをアップロード中...';

      try {
        // Create FormData
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append('files', files[i]);
        }

        console.log('[TEST] Creating OCR job...', { fileCount: files.length });

        // Step 1: Create OCR job
        const createResponse = await axios.post('/api/ocr-jobs', formData, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data'
          },
          timeout: 30000
        });

        const jobId = createResponse.data.job_id;
        console.log('[TEST] Job created:', jobId);
        
        progressBar.style.width = '20%';
        progressText.textContent = 'OCR処理中...';

        // Step 2: Poll for job status
        let attempts = 0;
        const maxAttempts = 120; // 2 minutes
        
        const pollInterval = setInterval(async () => {
          attempts++;
          
          if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            throw new Error('OCR処理がタイムアウトしました');
          }

          try {
            const statusResponse = await axios.get(`/api/ocr-jobs/${jobId}`, {
              headers: { 'Authorization': `Bearer ${token}` },
              timeout: 10000
            });

            const job = statusResponse.data.job;
            console.log('[TEST] Poll #' + attempts, job.status, job.processed_files + '/' + job.total_files);

            const processed = job.processed_files || 0;
            const total = job.total_files || files.length;
            const progress = 20 + Math.round((processed / total) * 80);
            
            progressBar.style.width = progress + '%';
            progressText.textContent = `処理中... ${processed}/${total} 完了`;

            if (job.status === 'completed') {
              clearInterval(pollInterval);
              progressBar.style.width = '100%';
              progressText.textContent = '完了！';

              console.log('[TEST] ========================================');
              console.log('[TEST] OCR completed successfully');
              console.log('[TEST] Extracted data:', job.extracted_data);
              console.log('[TEST] ========================================');

              // Display results
              displayResults(job.extracted_data);
              
              setTimeout(() => {
                progressDiv.classList.add('hidden');
              }, 2000);
            } else if (job.status === 'failed') {
              clearInterval(pollInterval);
              throw new Error(job.error_message || 'OCR処理に失敗しました');
            }
          } catch (pollError) {
            console.error('[TEST] Poll error:', pollError);
          }
        }, 1000);

      } catch (error) {
        console.error('[TEST] Error:', error);
        progressDiv.classList.add('hidden');
        errorDiv.classList.remove('hidden');
        errorContent.textContent = error.response?.data ? 
          JSON.stringify(error.response.data, null, 2) : 
          error.message;
      }
    });

    function displayResults(extractedData) {
      if (!extractedData) {
        resultsContent.innerHTML = '<p class="text-gray-600">データが抽出されませんでした</p>';
        resultsDiv.classList.remove('hidden');
        return;
      }

      // Display all fields
      const fields = [
        { key: 'property_name', label: '物件名' },
        { key: 'location', label: '所在地' },
        { key: 'station', label: '最寄り駅' },
        { key: 'walk_minutes', label: '徒歩分数' },
        { key: 'land_area', label: '土地面積' },
        { key: 'building_area', label: '建物面積' },
        { key: 'zoning', label: '用途地域' },
        { key: 'building_coverage', label: '建ぺい率' },
        { key: 'floor_area_ratio', label: '容積率' },
        { key: 'road_info', label: '道路情報' },
        { key: 'frontage', label: '間口' },
        { key: 'structure', label: '構造' },
        { key: 'built_year', label: '築年' },
        { key: 'current_status', label: '現況' },
        { key: 'yield', label: '利回り' },
        { key: 'occupancy', label: '入居状況' },
        { key: 'price', label: '価格' }
      ];

      let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
      
      fields.forEach(field => {
        const fieldData = extractedData[field.key];
        let value = '（なし）';
        let confidence = 0;
        
        // Extract value from {value, confidence} structure
        if (fieldData && typeof fieldData === 'object' && 'value' in fieldData) {
          value = fieldData.value || '（なし）';
          confidence = fieldData.confidence || 0;
        } else if (fieldData) {
          value = fieldData;
        }
        
        const confidenceColor = confidence > 0.7 ? 'text-green-600' : 
                                confidence > 0.4 ? 'text-yellow-600' : 'text-gray-400';
        
        html += `
          <div class="border border-gray-200 rounded-md p-3">
            <div class="text-xs text-gray-500 mb-1">${field.label}</div>
            <div class="font-medium text-gray-800">${value}</div>
            <div class="${confidenceColor} text-xs mt-1">信頼度: ${(confidence * 100).toFixed(0)}%</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      // Display raw data
      html += `
        <div class="mt-6 border-t border-gray-200 pt-6">
          <h3 class="font-medium text-gray-800 mb-2">Raw Data (JSON)</h3>
          <pre class="bg-gray-50 p-4 rounded text-xs overflow-auto max-h-96">${JSON.stringify(extractedData, null, 2)}</pre>
        </div>
      `;
      
      resultsContent.innerHTML = html;
      resultsDiv.classList.remove('hidden');
    }

    // Load token from localStorage if available
    window.addEventListener('load', () => {
      const savedToken = localStorage.getItem('auth_token');
      if (savedToken) {
        authTokenInput.value = savedToken;
      }
    });
  </script>
</body>
</html>
