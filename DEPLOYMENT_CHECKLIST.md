# デプロイチェックリスト

## 🚨 今回の教訓

**v3.149.0で発生した問題:**
- `PerformanceTimer.elapsed()` メソッドが未実装
- デプロイ後のテストを怠り、本番環境でエラー発生
- ユーザーがページを開けない状態になった

**原因:**
- 既存コードとの互換性チェック不足
- デプロイ後の動作確認を省略
- 急いで完了報告を行った

---

## ✅ 今後の必須チェックリスト

### **Phase 1: コード変更前**
- [ ] 既存コードでの使用状況を確認（grep検索）
- [ ] 依存関係を確認（import/export）
- [ ] 型定義を確認（TypeScript）

### **Phase 2: コード変更中**
- [ ] 変更する関数/クラスのすべてのメソッドを確認
- [ ] 既存のメソッド呼び出しをすべてリストアップ
- [ ] 後方互換性を維持

### **Phase 3: ビルド前**
- [ ] TypeScriptコンパイルエラーがないか確認
- [ ] 依存関係のインストール状態を確認
- [ ] 環境変数が正しく設定されているか確認

### **Phase 4: ビルド後**
- [ ] ビルドが成功したか確認
- [ ] バンドルサイズが異常に増加していないか確認
- [ ] ビルド警告がないか確認

### **Phase 5: デプロイ前**
- [ ] ローカルでpreviewモードをテスト
- [ ] 主要APIエンドポイントをcurlでテスト
- [ ] バージョン番号を更新

### **Phase 6: デプロイ直後（最重要）**
```bash
# 必ず以下のテストを実行すること
curl https://real-estate-200units-v2.pages.dev/api/health
curl https://real-estate-200units-v2.pages.dev/api/reinfolib/test
curl -I https://real-estate-200units-v2.pages.dev/
```

### **Phase 7: デプロイ後のスモークテスト（必須）**
```bash
# スモークテストスクリプトを実行
bash smoke-test.sh
```

### **Phase 8: ブラウザテスト（必須）**
- [ ] ルートページ（/）が開けるか確認
- [ ] ログインページが開けるか確認
- [ ] Consoleにエラーがないか確認
- [ ] 主要機能が動作するか確認

### **Phase 9: Git管理**
- [ ] 変更内容をコミット
- [ ] 適切なコミットメッセージを記述
- [ ] リモートリポジトリにプッシュ

### **Phase 10: ドキュメント更新**
- [ ] ハンドオーバードキュメントを更新
- [ ] 変更履歴を記録
- [ ] 既知の問題を記載

---

## 🔥 緊急ロールバック手順

デプロイ後にエラーが発生した場合の対応手順:

### **1. 問題の特定**
```bash
# エラーメッセージを確認
curl https://real-estate-200units-v2.pages.dev/api/health

# Console logを確認
# ブラウザでF12を開いてエラーを確認
```

### **2. 過去のデプロイURLにアクセス**
```bash
# Wranglerで過去のデプロイを確認
npx wrangler pages deployment list --project-name real-estate-200units-v2

# 最後に動作していたデプロイURLをユーザーに案内
```

### **3. Hotfixの実施**
```bash
# エラーを修正
# 必ずビルド・デプロイ後にテスト実行
npm run build
npx wrangler pages deploy dist --project-name real-estate-200units-v2

# デプロイ後、即座にテスト
curl https://real-estate-200units-v2.pages.dev/api/health
bash smoke-test.sh
```

---

## 📝 テンプレート: デプロイ完了報告

```markdown
## ✅ デプロイ完了報告 - v3.X.X

### **デプロイ情報**
- **バージョン**: v3.X.X
- **デプロイURL**: https://XXXXXXXX.real-estate-200units-v2.pages.dev
- **デプロイ時刻**: YYYY-MM-DD HH:MM:SS

### **変更内容**
- 変更1
- 変更2
- 変更3

### **テスト結果**
- ✅ Health check: OK
- ✅ REINFOLIB test: OK
- ✅ Root page: OK
- ✅ Smoke test: PASS (X/X tests)

### **ブラウザテスト結果**
- ✅ ルートページ: 正常に表示
- ✅ ログイン: 正常に動作
- ✅ Console: エラーなし

### **既知の問題**
- なし

### **次のアクション**
- ユーザーテスト依頼
- 機能Xの実装
```

---

## 💡 ベストプラクティス

### **1. 段階的デプロイ**
- 大きな変更は小さく分割
- 1つずつデプロイして動作確認
- 問題があればすぐに修正

### **2. テストファースト**
- デプロイ前にローカルでテスト
- デプロイ後に本番環境でテスト
- ユーザーに確認を依頼する前に自分で確認

### **3. ドキュメント重視**
- すべての変更を記録
- 問題が発生した場合の対応を記載
- 次の担当者が理解できるように

### **4. コミュニケーション**
- ユーザーに変更内容を明確に伝える
- 問題があればすぐに報告
- 嘘をつかない（「動作します」と言ったら本当に動作すること）

---

## ⚠️ やってはいけないこと

1. ❌ **デプロイ後のテストを省略**
2. ❌ **動作確認せずに「完了」と報告**
3. ❌ **エラーを隠す・無視する**
4. ❌ **ユーザーに未検証の機能をテストさせる**
5. ❌ **ロールバック手順を用意せずにデプロイ**

---

## 🎯 成功の基準

デプロイが成功したと言えるのは:

1. ✅ ビルドが成功
2. ✅ デプロイが成功
3. ✅ スモークテストがPASS
4. ✅ ブラウザで主要機能が動作
5. ✅ Consoleにエラーがない
6. ✅ ドキュメントが更新されている

これらすべてが満たされた時のみ「完了」と報告すること。
