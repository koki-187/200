<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v3.153.20 å®Œå…¨å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="p-8 bg-gray-100">
  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">v3.153.20 å®Œå…¨å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="grid grid-cols-2 gap-6">
      <!-- Status Panel -->
      <div class="col-span-2 p-4 bg-blue-50 rounded-lg">
        <h2 class="font-bold text-lg mb-2">ğŸ“Š ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <div id="status" class="text-sm">æº–å‚™ä¸­...</div>
      </div>

      <!-- Test Results -->
      <div class="col-span-2 p-4 bg-gray-50 rounded-lg">
        <h2 class="font-bold text-lg mb-2">âœ… ãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div id="results" class="text-sm space-y-1"></div>
      </div>

      <!-- Seller Dropdown Test -->
      <div class="p-4 bg-green-50 rounded-lg">
        <h2 class="font-bold text-lg mb-3">ğŸ‘¥ å£²ä¸»ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ†ã‚¹ãƒˆ</h2>
        <select id="test_seller_dropdown" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <div id="seller_count" class="text-sm font-semibold"></div>
        <div id="seller_list" class="text-xs text-gray-600 mt-2"></div>
      </div>

      <!-- Alert Test -->
      <div class="p-4 bg-yellow-50 rounded-lg">
        <h2 class="font-bold text-lg mb-3">ğŸš« Alert()æ¤œå‡ºãƒ†ã‚¹ãƒˆ</h2>
        <div id="alert_status" class="text-sm"></div>
        <button onclick="testAlertDetection()" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded">
          Alertæ¤œå‡ºãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
      </div>
    </div>

    <div class="mt-6 text-center">
      <button onclick="runAllTests()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg text-lg font-semibold">
        ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      </button>
      <a href="/deals/new" class="ml-4 bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold inline-block">
        ğŸ“ å®Ÿéš›ã®æ¡ˆä»¶ä½œæˆãƒšãƒ¼ã‚¸ã¸
      </a>
    </div>
  </div>

  <script>
    let testLogs = [];
    let alertDetected = false;

    // Alert detection
    const originalAlert = window.alert;
    window.alert = function(...args) {
      alertDetected = true;
      log(`ğŸš¨ ALERT DETECTED: ${args[0]}`, 'error');
      document.getElementById('alert_status').innerHTML = 
        `<div class="text-red-600 font-bold">âŒ Alertæ¤œå‡ºï¼</div><div class="text-xs mt-1">${args[0]}</div>`;
      return originalAlert.apply(this, args);
    };

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const logEntry = `<div class="flex items-start gap-2">
        <span class="text-gray-500 text-xs">${timestamp}</span>
        <span class="${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}">${message}</span>
      </div>`;
      
      testLogs.push(logEntry);
      document.getElementById('results').innerHTML = testLogs.join('');
      
      // Update status
      document.getElementById('status').innerHTML = `<div class="${type === 'error' ? 'text-red-600' : 'text-blue-600'}">${message}</div>`;
      
      console.log(`[${timestamp}] ${message}`);
    }

    async function testLogin() {
      log('ğŸ” ãƒ†ã‚¹ãƒˆ1: ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼');
      
      try {
        const response = await axios.post('/api/auth/login', {
          email: 'navigator-187@docomo.ne.jp',
          password: 'kouki187'
        });
        
        const token = response.data.token;
        const user = response.data.user;
        
        localStorage.setItem('token', token);
        localStorage.setItem('user', JSON.stringify(user));
        
        log(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${user.name} (${user.role})`, 'success');
        return { token, user };
      } catch (error) {
        log(`âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${error.message}`, 'error');
        throw error;
      }
    }

    async function testSellersAPI(token) {
      log('ğŸ‘¥ ãƒ†ã‚¹ãƒˆ2: å£²ä¸»ãƒ‡ãƒ¼ã‚¿APIå‘¼ã³å‡ºã—');
      
      try {
        const response = await axios.get('/api/auth/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const users = response.data.users || [];
        const sellers = users.filter(u => u.role === 'AGENT');
        
        log(`âœ… å£²ä¸»ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${sellers.length}å`, 'success');
        
        // Populate dropdown
        const select = document.getElementById('test_seller_dropdown');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        sellers.forEach(seller => {
          const option = document.createElement('option');
          option.value = seller.id;
          option.textContent = `${seller.name} (${seller.company_name || 'ä¼šç¤¾åãªã—'})`;
          select.appendChild(option);
        });
        
        // Update display
        document.getElementById('seller_count').innerHTML = 
          `<span class="text-green-600">âœ… ${sellers.length}åã®å£²ä¸»ã‚’è¡¨ç¤ºä¸­</span>`;
        document.getElementById('seller_list').innerHTML = 
          `å£²ä¸»ãƒªã‚¹ãƒˆ: ${sellers.map(s => s.name).join(', ')}`;
        
        log(`âœ… ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«${sellers.length}åè¿½åŠ å®Œäº†`, 'success');
        return sellers;
      } catch (error) {
        log(`âŒ å£²ä¸»ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw error;
      }
    }

    function testAlertDetection() {
      log('ğŸš« ãƒ†ã‚¹ãƒˆ3: Alertæ¤œå‡ºãƒ¡ã‚«ãƒ‹ã‚ºãƒ ');
      
      if (!alertDetected) {
        log('âœ… ã“ã‚Œã¾ã§ã«Alert()ã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'success');
        document.getElementById('alert_status').innerHTML = 
          '<div class="text-green-600 font-bold">âœ… Alertæœªæ¤œå‡º</div>';
      } else {
        log('âŒ Alert()ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼', 'error');
      }
    }

    async function testAlertCalledStatus() {
      log('ğŸ” ãƒ†ã‚¹ãƒˆ4: Alertå‘¼ã³å‡ºã—çŠ¶æ…‹ã®æœ€çµ‚ç¢ºèª');
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      if (alertDetected) {
        log('âŒ CRITICAL: Alert()ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ', 'error');
        return false;
      } else {
        log('âœ… SUCCESS: Alert()ã¯ä¸€åº¦ã‚‚å‘¼ã³å‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'success');
        document.getElementById('alert_status').innerHTML = 
          '<div class="text-green-600 font-bold">âœ… å®Œå…¨æˆåŠŸï¼šAlertæœªä½¿ç”¨</div>';
        return true;
      }
    }

    async function runAllTests() {
      testLogs = [];
      alertDetected = false;
      
      log('========================================');
      log('ğŸš€ v3.153.20 å®Œå…¨å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆé–‹å§‹');
      log('========================================');
      
      try {
        // Test 1: Login
        const { token, user } = await testLogin();
        
        // Test 2: Sellers API
        const sellers = await testSellersAPI(token);
        
        // Test 3: Alert Detection
        testAlertDetection();
        
        // Test 4: Final Alert Check
        await testAlertCalledStatus();
        
        // Summary
        log('========================================');
        log('âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ï¼', 'success');
        log(`ğŸ“Š çµæœã‚µãƒãƒªãƒ¼:`);
        log(`   - ãƒ­ã‚°ã‚¤ãƒ³: âœ… æˆåŠŸ`);
        log(`   - å£²ä¸»ãƒ‡ãƒ¼ã‚¿å–å¾—: âœ… ${sellers.length}å`);
        log(`   - Alertæ¤œå‡º: ${alertDetected ? 'âŒ æ¤œå‡º' : 'âœ… ãªã—'}`);
        log('========================================');
        
        document.getElementById('status').innerHTML = 
          `<div class="text-green-600 font-bold text-lg">âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ï¼å•é¡Œãªã—</div>`;
        
      } catch (error) {
        log(`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        document.getElementById('status').innerHTML = 
          `<div class="text-red-600 font-bold">âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—</div>`;
      }
    }

    // Auto-run on load
    window.addEventListener('DOMContentLoaded', () => {
      log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
      document.getElementById('alert_status').innerHTML = 
        '<div class="text-gray-600">Alertç›£è¦–ä¸­...</div>';
      setTimeout(runAllTests, 1000);
    });
  </script>
</body>
</html>
