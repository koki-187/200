# 📊 ギャップ分析レポート v3.1.0

**分析日**: 2025-11-19  
**対象バージョン**: v3.1.0  
**分析者**: AI Assistant  
**目的**: ユーザー要件と現在の実装状況のギャップを特定し、優先順位を付ける

---

## 🎯 ユーザー指摘内容のまとめ

### 確認できなかった／未実装の可能性が高い機能

1. **売主による物件情報アップロード**
   - PDF・JPEG等をアップロードして物件情報を抽出する機能の動作確認不足

2. **不足情報の自動検出と48時間以内の一次回答督促機能**
   - アップロードした物件データの不足項目を自動判定し、48時間以内に補足情報を求める仕組み

3. **AIによる評価・分析・スコアリング**
   - 用地に関するAI分析（42条・43条道路や用途地域・高さ制限・駐車場規制など）
   - プラン作成の可能性、注意点や調査事項を自動で要約してスコアリング
   - メール送信前まで整える機能

4. **マップ表示や過去物件の履歴**
   - 過去に提案した物件や住所を地図で表示する機能

5. **買主／社内稟議用のステータス管理と通知**
   - 売主・買主・社内稟議者間でコメントや結果のやり取りを残し、次のアクションプランを自動通知

6. **ユーザー管理や権限設定**
   - 売主担当者、買主担当者、管理者のアカウント管理・アクセス権限の設計

---

## ✅ 実装済み機能との照合

### 1. 売主による物件情報アップロード
**ユーザー指摘**: PDF・JPEG等をアップロードして物件情報を抽出する機能が実際に動作するか確認できていない

**現状**:
- ✅ **実装済み**: `src/routes/property-ocr.ts` で複数ファイル（最大10個）のOCR処理が実装されている
- ✅ **対応形式**: JPG, PNG, WEBP, PDF
- ✅ **抽出フィールド**: 16フィールド（物件名、所在地、駅、徒歩、面積、用途地域、建ぺい率、容積率等）
- ✅ **API**: `/api/property-ocr/extract`, `/api/property-ocr/extract-multiple`

**ギャップ**: ❌ **フロントエンドUIが未実装**
- バックエンドAPIは完全実装済みだが、ユーザーがブラウザからアップロードできるUIがない

**対応**: フロントエンドUIの実装が必要（優先度: 🔴 HIGH）

---

### 2. 不足情報の自動検出と48時間以内の一次回答督促機能
**ユーザー指摘**: アップロードした物件データの不足項目を自動判定し、48時間以内に補足情報を求める仕組みは未実装の可能性

**現状**:
- ✅ **48時間レスポンスタイム管理**: `src/utils/businessTime.ts` で営業日ベースの48時間計算が実装済み
- ✅ **期限通知CRON**: 6時間ごとに実行されるスケジューラーが実装済み
- ✅ **不足情報トラッキング**: `deals.missing_fields` フィールドでJSON形式で保存

**ギャップ**: ⚠️ **自動検出ロジックが不明確**
- 不足項目を自動判定するロジックの実装状況が不明
- missing_fieldsへの自動セットが実装されているか確認が必要

**対応**: 不足情報自動検出ロジックの実装または強化（優先度: 🟡 MEDIUM）

---

### 3. AIによる評価・分析・スコアリング

#### 3-1. 建築規制の自動チェック（42条・43条）
**ユーザー指摘**: 用地に関するAI分析（42条・43条道路や用途地域・高さ制限・駐車場規制など）

**現状**:
- ✅ **AI投資分析・提案生成**: `src/routes/ai-proposals.ts` で実装済み
  - GPT-4oによる投資ポテンシャル評価
  - 強み・リスク分析
  - 収益シミュレーション
  - 開発プラン提案
- ⚠️ **建築規制の具体的チェック**: AI提案に含まれるが、構造化されていない可能性

**ギャップ**: ⚠️ **建築規制の明示的チェック機能が不足**
- 42条・43条の明示的な判定ロジックが未実装
- 駐車場規制、高さ制限等のデータベース化が未実装

**対応**: 建築規制チェックAPI実装（優先度: 🟡 MEDIUM）

#### 3-2. 1次情報スコアリング
**ユーザー指摘**: 入力時点での評価、情報充足度・規制リスク・投資適合度のスコアリング

**現状**:
- ✅ **買取条件スコアリング**: v3.1.0で実装済み
  - 対象エリア判定
  - 買取条件チェック（5条件）
  - スコア計算（0-100点）
  - 総合判定（PASS/SPECIAL_REVIEW/FAIL）
- ⚠️ **情報充足度の明示的スコア**: 未実装の可能性

**ギャップ**: ⚠️ **多角的なスコアリングが不足**
- 情報充足度スコアの明示化が必要
- 規制リスクスコアの独立表示が必要
- 投資適合度スコアの独立表示が必要

**対応**: スコアリング機能の拡張（優先度: 🟡 MEDIUM）

#### 3-3. Gmail送信準備機能
**ユーザー指摘**: メール送信前まで整える機能、Gmail下書き作成

**現状**:
- ✅ **Resend APIでメール送信**: 実装済み
  - 新規案件作成通知
  - 新規メッセージ通知
  - @メンション通知
  - 期限通知
- ❌ **Gmail API統合**: 未実装

**ギャップ**: ❌ **Gmail下書き作成機能が未実装**
- Gmail APIの統合が必要
- OAuth2認証の実装が必要

**対応**: Gmail API統合（優先度: 🟢 LOW - Resendで代替可能）

---

### 4. マップ表示や過去物件の履歴
**ユーザー指摘**: 過去に提案した物件や住所を地図で表示する機能

**現状**:
- ❌ **地図表示機能**: 完全未実装
- ❌ **ジオコーディング（住所→座標変換）**: 未実装
- ❌ **物件履歴の地図表示**: 未実装

**ギャップ**: ❌ **地図機能が完全未実装**

**対応**: 地図表示機能の実装（優先度: 🟡 MEDIUM）
- Geocoding API（OpenStreetMap Nominatim等）
- Leaflet.js または Google Maps API
- 物件位置のマーカー表示
- 過去物件の履歴表示

---

### 5. 買主／社内稟議用のステータス管理と通知
**ユーザー指摘**: 売主・買主・社内稟議者間でコメントや結果のやり取りを残し、次のアクションプランを自動通知

**現状**:
- ✅ **ステータス管理**: 実装済み（NEW, IN_REVIEW, REPLIED, CLOSED）
- ✅ **チャット機能**: 実装済み
  - メッセージ投稿
  - ファイル添付
  - @メンション
- ✅ **メール通知**: 実装済み
  - 新規案件作成通知
  - 新規メッセージ通知
  - @メンション通知

**ギャップ**: ⚠️ **社内稟議ステータスが不明確**
- 社内稟議専用のステータスやワークフローが未整備の可能性
- アクションプラン自動通知の具体的な実装が不明

**対応**: ステータス管理の拡張（優先度: 🟢 LOW - 既存機能で対応可能）

---

### 6. ユーザー管理や権限設定
**ユーザー指摘**: 売主担当者、買主担当者、管理者のアカウント管理・アクセス権限の設計

**現状**:
- ✅ **ロール管理**: 実装済み（ADMIN, AGENT）
- ✅ **認証システム**: 実装済み（JWT、PBKDF2）
- ✅ **権限チェック**: API レベルで実装済み（authMiddleware, adminOnly）

**ギャップ**: ⚠️ **買主ロールが不足**
- 現状は ADMIN（管理者/買主）、AGENT（売主）の2ロール
- 買主専用ロールや社内稟議者ロールが未定義

**対応**: ロールの拡張（優先度: 🟢 LOW - 現状で運用可能）

---

## 📊 優先順位付けされた未実装機能リスト

### 🔴 HIGH（即座に実装すべき）

1. **フロントエンドUI：買取条件サマリーページ** (1-2時間)
   - 対象エリア・買取条件・検討外エリアの可視化
   - 推奨URL: `/purchase-criteria`

2. **フロントエンドUI：案件登録フォームでのリアルタイムチェック** (2-3時間)
   - 物件情報入力フォームに買取条件チェック結果を表示
   - スコア、バッジ、合格/不合格条件の詳細表示

3. **フロントエンドUI：物件OCRアップロード画面** (2-3時間)
   - PDF/画像ファイルのアップロードUI
   - 抽出結果の表示と編集
   - 案件登録フォームへの自動入力

**合計推定工数**: 5-8時間

---

### 🟡 MEDIUM（次フェーズで実装推奨）

4. **地図表示機能** (3-4時間)
   - Geocoding API統合（住所→座標変換）
   - Leaflet.js地図表示
   - 物件位置マーカー表示
   - 過去物件履歴表示

5. **建築規制自動チェック機能** (4-6時間)
   - 42条・43条の自動判定ロジック
   - 地域ごとの規制データベース構築
   - AI分析への統合

6. **1次情報スコアリング機能の強化** (2-3時間)
   - 情報充足度スコアの明示化
   - 規制リスクスコアの独立表示
   - 投資適合度スコアの独立表示
   - スコア詳細画面の実装

7. **不足情報自動検出ロジックの強化** (2-3時間)
   - 必須フィールドの自動判定
   - missing_fieldsの自動セット
   - 不足情報リストのUI表示

**合計推定工数**: 11-16時間

---

### 🟢 LOW（将来的に検討）

8. **Gmail API統合** (2-3時間)
   - OAuth2認証実装
   - Gmail下書き作成機能
   - ※Resend APIで代替可能なため優先度低

9. **ロールの拡張** (1-2時間)
   - 買主専用ロール追加
   - 社内稟議者ロール追加
   - ※現状の2ロールで運用可能

10. **ステータス管理の拡張** (2-3時間)
    - 社内稟議ステータスの追加
    - ワークフロー自動化
    - ※既存のステータスで対応可能

**合計推定工数**: 5-8時間

---

## 🎯 推奨実装計画

### Phase 1: フロントエンドUI実装（今セッション）
**推定工数**: 5-8時間

1. 買取条件サマリーページ作成
2. 案件登録フォームでのリアルタイムチェック
3. 物件OCRアップロード画面

**目標**: ユーザーが買取条件チェック機能を実際に使用できるようにする

---

### Phase 2: 地図・スコアリング機能（次セッション）
**推定工数**: 11-16時間

1. 地図表示機能
2. 建築規制自動チェック機能
3. 1次情報スコアリング機能の強化
4. 不足情報自動検出ロジックの強化

**目標**: ユーザー要件の主要機能をすべて実装

---

### Phase 3: 拡張機能（将来）
**推定工数**: 5-8時間

1. Gmail API統合
2. ロールの拡張
3. ステータス管理の拡張

**目標**: システムの完成度を高める

---

## 📝 結論

### 実装状況サマリー

| カテゴリ | 実装済み | 未実装 | 実装率 |
|---------|---------|--------|--------|
| 認証・ユーザー管理 | ✅ | - | 100% |
| 案件管理 | ✅ | - | 100% |
| OCR機能（バックエンド） | ✅ | - | 100% |
| AI分析・提案 | ✅ | 建築規制明示化 | 80% |
| メール通知 | ✅ | Gmail API | 90% |
| ファイル管理 | ✅ | - | 100% |
| コミュニケーション | ✅ | - | 100% |
| **フロントエンドUI** | ❌ | **全般** | **20%** |
| 地図表示 | ❌ | 完全未実装 | 0% |
| 建築規制チェック | ⚠️ | 明示化必要 | 40% |
| スコアリング | ✅ | 多角化必要 | 70% |

### キーポイント

1. **バックエンドは充実している**
   - OCR、AI分析、買取条件チェック等のAPIは完全実装済み
   - 本番環境にデプロイ済みで正常動作している

2. **フロントエンドUIが最大のギャップ**
   - バックエンドAPIは使用できるのに、ユーザーがアクセスできるUIがない
   - 特に買取条件チェック、物件OCRアップロードのUIが未実装

3. **優先順位**
   - Phase 1（フロントエンドUI）を今セッションで実装
   - Phase 2（地図・スコアリング）を次セッションで実装
   - Phase 3（拡張機能）は必要に応じて実装

---

**分析者**: AI Assistant  
**分析日**: 2025-11-19  
**バージョン**: v3.1.0  
**次回更新**: Phase 1完了後、v3.2.0として更新
