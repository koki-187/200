# 🧪 v3.152.8 OCR機能テストガイド

**作成日時**: 2025-12-08  
**本番URL**: https://38e15689.real-estate-200units-v2.pages.dev  
**ステータス**: ✅ OpenAI API 接続確認済み

---

## ✅ 完了した修正

### 1. OpenAI API接続の修正
- ❌ 問題: 環境変数名が `OPEN_AI_API_KEY`（アンダースコア2つ）
- ✅ 修正: `OPENAI_API_KEY`（アンダースコア1つ）に変更
- ✅ 結果: OpenAI API正常動作確認

### 2. テスト結果
**OpenAI API接続テスト**:
```json
{
  "success": true,
  "model": "gpt-4o-2024-08-06",
  "tokens_used": {
    "total_tokens": 47
  }
}
```

**使用モデル**: `gpt-4o-2024-08-06`（最新版）

---

## 🧪 ブラウザでのOCRテスト手順

### Step 1: ブラウザでアクセス

1. **本番環境URL**:  
   ```
   https://38e15689.real-estate-200units-v2.pages.dev
   ```

2. **ログイン**:
   - Email: `navigator-187@docomo.ne.jp`
   - Password: `kouki187`

### Step 2: 開発者ツールを開く

1. **F12キー**を押す（または右クリック → 「検証」）
2. **Console タブ**を選択
3. ログをクリア（🚫アイコンをクリック）

### Step 3: 新規案件作成ページに移動

1. 左メニューから「案件一覧」をクリック
2. 「新規案件作成」ボタンをクリック

### Step 4: PDFファイルをアップロード

以下のファイルをドラッグ&ドロップ:
- ✅ `浦安市堀江２丁目３６７－２不動産登記（土地全部事項）2025112101245116.PDF`
- ✅ `浦安市堀江２丁目３６７－４不動産登記（土地全部事項）2025112101245121.PDF`

### Step 5: OCR処理を確認

#### ✅ 期待される動作

**プログレスバー**:
```
PDF変換中... 1/2 (浦安市堀江２丁目３６７－２...)
↓
PDF変換完了。OCR処理を開始します...
↓
OCR処理中... (1/X)
↓
OCR処理が完了しました
```

**Consoleログ**:
```
[PDF Conversion] 浦安市堀江２丁目３６７－２... から X 枚の画像を生成しました
[OCR] Processing X total files (after PDF conversion)
[OCR] Task completed successfully
[OCR] extracted_data keys: (17) ["property_name", "location", "land_area", ...]
✅ getFieldValue: extracted value from object: "浦安市堀江２丁目３６７－２"
Set title: 浦安市堀江２丁目３６７－２物件 (length: 15)
Set location: 浦安市堀江２丁目３６７－２ (length: 13)
Set land_area: XXX.XX㎡ (length: X)
```

**フォームフィールド**:
- ✅ 「物件タイトル」に値が入力されている
- ✅ 「所在地」に住所が入力されている
- ✅ 「土地面積」に面積が入力されている
- ✅ 「用途地域」に地域が入力されている

---

## 🔍 トラブルシューティング

### ❌ Case 1: PDFが変換されない

**症状**:
```
[PDF Conversion] PDF変換エラー: ...
```

**原因**: PDF.js の読み込み失敗

**対処法**:
1. ページをリロード（Ctrl+R または Cmd+R）
2. ブラウザのキャッシュをクリア（Ctrl+Shift+Delete）

### ❌ Case 2: OCRが実行されない

**症状**:
```
[OCR] No files to process
```

**原因**: ファイルが物件写真として判定された

**対処法**:
- ファイル名に「外観」「内観」「写真」などが含まれていないか確認

### ❌ Case 3: extracted_dataが空

**症状**:
```json
{
  "property_name": { "value": null, "confidence": 0 }
}
```

**原因**: OpenAI APIがデータを抽出できなかった

**対処法**:
1. PDF内のテキストが読み取り可能か確認（スキャン画像ではない）
2. PDFの画質を確認
3. Consoleに `[OpenAI]` エラーログがないか確認

---

## 📊 期待されるデータ抽出フィールド（17個）

以下のフィールドが抽出されることを期待:

1. `property_name` - 物件名
2. `location` - 所在地
3. `station` - 最寄駅
4. `walk_minutes` - 徒歩分数
5. `land_area` - 土地面積
6. `building_area` - 建物面積
7. `zoning` - 用途地域
8. `building_coverage` - 建蔽率
9. `floor_area_ratio` - 容積率
10. `price` - 価格
11. `structure` - 構造
12. `built_year` - 建築年
13. `road_info` - 道路情報
14. `current_status` - 現況
15. `yield` - 利回り
16. `occupancy` - 入居状況
17. `overall_confidence` - 全体信頼度

---

## 🎯 テスト成功の判定基準

### ✅ 最低限の成功条件

以下のフィールドが正しく抽出されていること:
- `property_name` または `location`（どちらか必須）
- `land_area`（土地面積）
- `zoning`（用途地域）

### 🌟 完全成功の条件

- 17個のフィールドすべてに値がある（nullでない）
- `overall_confidence` が 0.6 以上
- フォームフィールドに正しく反映されている

---

## 📝 テスト結果の報告

以下の情報をスクリーンショットで送ってください:

1. **Consoleタブ全体**
   - `[PDF Conversion]` ログ
   - `[OCR]` ログ
   - `extracted_data keys: (X)` の内容
   - エラーがあれば赤いエラーログ

2. **フォーム画面**
   - 「物件タイトル」フィールド
   - 「所在地」フィールド
   - 「土地面積」フィールド
   - その他の入力フィールド

3. **Network タブ**（オプション）
   - `/api/ocr-jobs` リクエスト
   - レスポンスの Status Code
   - レスポンスボディ

---

## 🔧 その他のテスト項目

### 物件情報自動入力ボタン

1. 「所在地」に `東京都港区六本木` を入力
2. 「物件情報を自動入力」ボタンをクリック
3. ボタンが「取得中...」に変化することを確認
4. アラートまたはフォーム更新を確認

### リスクチェックボタン

1. 「所在地」に `東京都港区六本木` を入力
2. 「リスクチェック」ボタンをクリック
3. ボタンが「チェック中...」に変化することを確認
4. リスク情報が表示されることを確認

### 売主プルダウン

1. 「売主」ドロップダウンを開く
2. AGENTロールのユーザーが表示されることを確認

---

## 💡 重要な注意事項

### PDF処理について

- **PDFは自動的に画像に変換されます**（フロントエンド処理）
- 1ページのPDFから1枚の画像が生成されます
- 複数ページのPDFの場合、各ページが個別に処理されます

### ブラウザキャッシュについて

- **スーパーリロード**を実行してください:
  - Windows: `Ctrl + Shift + R`
  - Mac: `Cmd + Shift + R`
- これにより、最新のJavaScriptが読み込まれます

### OpenAI APIトークン使用量

- **1枚の画像**: 約700-1500 tokens
- **コスト**: 約 $0.002-0.006（0.2〜0.6円）
- テストで複数回実行しても問題ありません

---

## 📞 サポート情報

- **本番URL**: https://38e15689.real-estate-200units-v2.pages.dev
- **バージョン**: v3.152.8
- **Git コミット**: `1cbc7ae`
- **OpenAI モデル**: `gpt-4o-2024-08-06`

---

**テスト後、Consoleログとフォーム画面のスクリーンショットをお送りください。**
