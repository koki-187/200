# 📊 機能ギャップ分析レポート

**作成日**: 2025-11-20  
**対象**: 200棟土地仕入れ管理システム  
**比較対象**: 仕様書（テキスト.txt） vs 現在の実装（v3.32.0）

---

## 📝 仕様書から読み取れる主要機能（理想）

### 1. 売側フォームとOCR解析
- PDF/JPEGのマイソクや図面をアップロードしてOCR解析
- 所在地、土地面積、用途地域・建蔽率・容積率・高度地区や防火区分、接道状況、現況、価格などの一次情報を入力
- 入力後に法令ベースのリスク判定を実行し、48時間以内に一次回答を自動生成

### 2. 法制度ベースAIリスク判定エンジン
- 国交省APIおよび国土数値情報を取得
- 建築基準法42条・43条に基づく再建築可否、セットバックの必要性、道路幅員による容積率補正などを判定
- 用途地域・建蔽率・容積率、地区計画、高度地区、防火/準防火地域、ハザードマップ（洪水・土砂・液状化）といった法規制を自動照合
- 権利関係リスク（借地権や賃借人、境界未確定、私道・通行地役権）を評価し、注意点とアドバイスを生成
- 建築基準法43条第2項2号による「接道がなく再建築不可とされた土地でも条件を満たせば許可を得られる制度」についても考慮

### 3. 買主ニーズ AI スコアリング
- Deals・Requirements・AreaCriteria の3テーブルで Must 条件と Wants 条件を定義
- Must が満たされない物件は自動除外し、Wants は加点方式で計算
- 購入ニーズのエリア別仮説（八王子・厚木〜相模原・松本など）を使ってマッチ度の推定
- AIレコメンデーションシステムでユーザーの好みや行動履歴に基づいて最適な物件を推薦
- 継続的な学習により重み付けを改善

### 4. 外部データソースの活用
- 国土数値情報ダウンロードサイトから地形、土地利用、公共施設、交通、災害リスク情報、都市計画、地価など取得
- ハザードマップポータルサイトで洪水・土砂災害・高潮・津波のリスクや道路防災情報を重ねて表示

### 5. テンプレートとGAS連携
- Gmailテンプレート v7に物件情報とリスク判定結果を差し込んで顧客へのメールを作成
- Google Apps Script (auto_process.gs) によるフォーム送信トリガー・シート整形・マッチ度判定・次アクション提案

---

## ✅ 現在の実装状況（v3.32.0）

### 実装済み機能（50/50 - 100%）

#### 1. OCR・AI機能 ✅
- ✅ 登記簿謄本OCR（OpenAI GPT-4 Vision）
- ✅ OCR完全非同期化（ポーリングベース）
- ✅ 並列ファイル処理（最大3並列、処理速度3倍向上）
- ✅ PDF/画像混在OCR（最大10ファイル）
- ✅ フィールド毎の信頼度スコア（0.0〜1.0）
- ✅ OCR履歴管理機能（検索・フィルター・再利用）
- ✅ 名刺OCR機能（縦型・横型・英語対応）
- ✅ 物件情報OCR（複数ファイル一括処理）
- ✅ **買取条件自動チェック機能** v3.1.0
  - 対象エリア判定（埼玉県、東京都、千葉県西部、神奈川県、愛知県）
  - 買取条件判定（駅徒歩、土地面積、間口、建ぺい率、容積率）
  - 検討外エリア判定（調整区域、防火地域）
  - ニッチエリア・特殊案件フラグ対応
- ✅ AI投資分析・提案生成（GPT-4o）
  - 投資ポテンシャル評価
  - 強み・リスク分析
  - 収益シミュレーション
  - 買主カスタマイズ提案

#### 2. 案件管理 ✅
- ✅ 案件CRUD操作
- ✅ ステータス管理（NEW, IN_REVIEW, REPLIED, CLOSED）
- ✅ 48時間レスポンスタイム管理
- ✅ 不足情報トラッキング
- ✅ 高度なフィルター機能
- ✅ ソート機能
- ✅ 検索機能
- ✅ Excelエクスポート
- ✅ グリッド/リスト表示切替

#### 3. テンプレート管理 ✅
- ✅ 4種類のプリセットテンプレート
  - 住宅用地（標準）、マンション用地（200棟向け）
  - 商業用地、投資用地（高利回り）
- ✅ カスタムテンプレートCRUD
- ✅ テンプレートインポート/エクスポート（JSON形式）
- ✅ テンプレートプレビュー機能

#### 4. コミュニケーション ✅
- ✅ チャット機能
- ✅ ファイル添付機能
- ✅ メッセージ検索機能
- ✅ @メンション機能
- ✅ メール自動通知（Resend API）
- ✅ リアルタイム通知
- ✅ プッシュ通知（Web Push API）

#### 5. その他 ✅
- ✅ 認証・セキュリティ（JWT、PBKDF2、XSS/CSRF対策）
- ✅ ユーザー管理（CRUD、ロール管理）
- ✅ ファイル管理（Cloudflare R2統合）
- ✅ PDF生成（契約書、報告書）
- ✅ 監査・ログ
- ✅ バックアップ・復元

---

## ⚠️ 未実装機能・ギャップ分析

### 🔴 HIGH PRIORITY（重要度：高）

#### 1. 国交省API・国土数値情報の統合 ❌
**仕様書の要求**:
- 国交省不動産情報ライブラリおよび国土数値情報（NLNI）を取得
- 建築基準法42条・43条に基づく再建築可否の判定
- 道路種別判定（私道、未指定道路の判別）
- セットバックの必要性判定
- 道路幅員による容積率補正

**現在の実装**:
- ❌ 国交省APIとの統合なし
- ❌ 国土数値情報（NLNI）の取得なし
- ⚠️ 買取条件チェックは実装済みだが、外部APIデータに基づいていない（ユーザー入力ベース）

**ギャップ**:
- 外部APIとの連携機能が完全に未実装
- 法規制の自動照合ができていない
- 再建築可否の判定ロジックがない

#### 2. 高度な法制度リスク判定エンジン ❌
**仕様書の要求**:
- 用途地域・建蔽率・容積率・地区計画・高度地区の自動取得と判定
- 防火/準防火地域の判定
- ハザードマップ（洪水・土砂災害・液状化）のリスク評価
- 権利関係リスク（借地権、賃借人、境界未確定、私道・通行地役権）の評価
- 建築基準法43条第2項（認定・許可）の判定

**現在の実装**:
- ⚠️ 基本的な買取条件チェックのみ（`src/utils/purchaseCriteria.ts`）
- ⚠️ 対象エリア判定（都道府県レベル）
- ⚠️ 検討外エリア判定（調整区域、防火地域の文字列マッチング）
- ❌ ハザードマップとの連携なし
- ❌ 権利関係リスク評価なし
- ❌ 建築基準法の詳細判定なし

**ギャップ**:
- 法規制の自動照合が不完全（ユーザー入力依存）
- ハザードマップの統合が未実装
- 権利関係リスクの評価機能がない
- 建築基準法の詳細判定ロジックがない

#### 3. 継続学習型AIスコアリング ❌
**仕様書の要求**:
- 過去の成約データや顧客のフィードバックを用いて重み係数を自動調整
- ユーザーの好みや行動履歴に基づいて最適な物件を推薦
- エリア特性の定量化（国交省取引情報、地価、公示地価の推移分析）
- ユーザーセグメンテーション（投資目的・自用目的・資金計画など）

**現在の実装**:
- ⚠️ 固定の買取条件チェックのみ
- ❌ 学習機能なし
- ❌ 行動履歴ベースのレコメンデーションなし
- ❌ ユーザーセグメンテーションなし

**ギャップ**:
- AIの「学習」機能が未実装
- スコアリングの重み付けが固定
- パーソナライズされた推薦機能がない

#### 4. ハザードマップポータルサイトとの統合 ❌
**仕様書の要求**:
- 洪水・土砂災害・高潮・津波のリスク情報を取得
- 道路防災情報を重ねて表示
- 地番レベルでの災害リスク評価
- 複合リスク（洪水+土砂災害）の評価

**現在の実装**:
- ❌ ハザードマップとの統合なし
- ❌ 災害リスク評価機能なし

**ギャップ**:
- 災害リスク評価機能が完全に未実装
- 外部ハザードマップデータとの連携がない

### 🟡 MEDIUM PRIORITY（重要度：中）

#### 5. Google Apps Script (GAS) 連携 ❌
**仕様書の要求**:
- auto_process.gs によるフォーム送信トリガー
- シート整形
- マッチ度判定
- 次アクション提案
- Webhook受信機能
- メール開封状況・返信状況の記録

**現在の実装**:
- ✅ メール自動通知（Resend API）は実装済み
- ❌ GASとの連携なし
- ❌ スプレッドシートとの統合なし
- ❌ Webhook機能なし

**ギャップ**:
- Google Workspace統合が未実装
- スプレッドシートベースのワークフローがない

#### 6. Gmailテンプレート v7 への差し込み ❌
**仕様書の要求**:
- 物件情報とリスク判定結果をGmailテンプレートに差し込み
- リスクランクに応じて文面のトーンやアクション推奨が変化
- LINEテンプレートも同様に対応

**現在の実装**:
- ✅ メール自動通知機能は実装済み（Resend API）
- ❌ Gmailテンプレート v7 との連携なし
- ❌ LINEテンプレートとの連携なし
- ⚠️ 独自のメールテンプレートシステム

**ギャップ**:
- Gmail/LINEテンプレートとの統合がない
- 代替としてResend APIを使用しているが、仕様書の要求とは異なる

#### 7. OCR精度の向上 ⚠️
**仕様書の要求**:
- Google Vision APIなどの高精度OCRサービスへの切り替え
- 正規表現での出力結果補正
- フォーマットが異なる場合の誤認識対策

**現在の実装**:
- ✅ OpenAI GPT-4 Vision を使用（高精度）
- ✅ 信頼度スコア表示
- ⚠️ Google Vision APIは未使用

**ギャップ**:
- 既にGPT-4 Visionで高精度を達成しているため、優先度は低い
- Google Vision APIとの併用は検討の余地あり

#### 8. エリア特性の定量化 ❌
**仕様書の要求**:
- 国交省取引情報や地価、公示地価の推移を分析
- 賃料利回りや需要動向を数値化
- エリア別スコアリングの仮説を定量的なデータで裏付け

**現在の実装**:
- ❌ エリア特性の定量化なし
- ⚠️ エリア判定は都道府県・市区町村名の文字列マッチングのみ

**ギャップ**:
- 定量的なエリア分析機能が未実装
- 外部データソースとの連携がない

### 🟢 LOW PRIORITY（重要度：低）

#### 9. 住所入力のサジェスト機能 ❌
**仕様書の要求**:
- Google Maps APIなどのジオコーディングを使って候補を提示
- 住所候補のサジェスト
- 入力の一貫性確保と誤入力防止

**現在の実装**:
- ❌ 住所サジェスト機能なし
- ⚠️ 手動入力のみ

**ギャップ**:
- UX改善機能が未実装
- ジオコーディングAPIとの連携がない

#### 10. データ更新の自動化 ❌
**仕様書の要求**:
- 国交省APIやNLNI、自治体オープンデータの更新スケジュールを監視
- データ更新時にリスク判定ロジックやYAMLルールを自動更新
- YAMLのバージョン管理とデプロイ時の最新ルール読み込み

**現在の実装**:
- ❌ 自動更新機能なし
- ❌ YAMLベースのルール管理なし
- ⚠️ コードベースでルールを管理

**ギャップ**:
- 保守性の自動化機能が未実装
- データ更新プロセスが手動

---

## 📊 実装状況サマリー

| カテゴリ | 仕様書の要求 | 実装状況 | ギャップ |
|---------|-------------|---------|---------|
| **OCR・データ入力** | PDF/JPEG OCR、自動抽出 | ✅ 実装済み | 小（精度向上の余地） |
| **買取条件チェック** | 基本的な条件判定 | ✅ 実装済み | 小（外部APIなし） |
| **法制度リスク判定** | 詳細な法規制チェック | ⚠️ 部分実装 | **大（国交省API未統合）** |
| **建築基準法判定** | 42条・43条判定 | ❌ 未実装 | **大（完全に未実装）** |
| **ハザードマップ** | 災害リスク評価 | ❌ 未実装 | **大（完全に未実装）** |
| **権利関係リスク** | 借地権・私道評価 | ❌ 未実装 | **大（完全に未実装）** |
| **AIスコアリング** | 継続学習型推薦 | ⚠️ 固定ルール | **中（学習機能なし）** |
| **外部データ統合** | 国交省・NLNI | ❌ 未実装 | **大（完全に未実装）** |
| **GAS連携** | スプレッドシート統合 | ❌ 未実装 | 中（代替実装あり） |
| **Gmailテンプレート** | テンプレート差し込み | ⚠️ 独自実装 | 小（Resend使用） |
| **テンプレート管理** | カスタムテンプレート | ✅ 実装済み | なし |
| **コミュニケーション** | チャット・通知 | ✅ 実装済み | なし |
| **案件管理** | CRUD・ステータス管理 | ✅ 実装済み | なし |

---

## 🎯 実装優先度ランキング

### 🔴 最優先（Phase 1）

1. **国交省API・国土数値情報の統合**
   - 建築基準法42条・43条の判定ロジック実装
   - 道路種別・幅員の自動取得
   - 用途地域・建蔽率・容積率の自動取得

2. **ハザードマップポータルサイトとの統合**
   - 洪水・土砂災害リスクの自動評価
   - 複合リスクの判定ロジック

3. **権利関係リスク評価**
   - 借地権・私道・通行地役権のチェック機能
   - 境界未確定リスクの評価

### 🟡 重要（Phase 2）

4. **継続学習型AIスコアリング**
   - 過去データからの学習機能
   - 重み係数の自動調整
   - ユーザーセグメンテーション

5. **エリア特性の定量化**
   - 国交省取引情報の取得
   - 地価・公示地価の分析
   - 賃料利回りの算出

6. **GAS連携**（オプション）
   - スプレッドシートとの統合
   - Webhook機能の実装

### 🟢 推奨（Phase 3）

7. **住所入力サジェスト**
   - Google Maps APIのジオコーディング
   - 住所候補の自動表示

8. **データ更新の自動化**
   - 外部データソースの監視
   - YAMLルールの自動更新

9. **OCR精度の向上**
   - Google Vision APIの併用
   - 正規表現による補正強化

---

## 💡 実装推奨事項

### 技術的推奨

1. **外部API統合の設計**
   ```typescript
   // src/integrations/mlit-api.ts (国交省API)
   // src/integrations/nlni.ts (国土数値情報)
   // src/integrations/hazard-map.ts (ハザードマップ)
   ```

2. **リスク判定エンジンの拡張**
   ```typescript
   // src/utils/riskEngine.ts
   // - 建築基準法判定
   // - ハザードリスク評価
   // - 権利関係リスク評価
   ```

3. **AIスコアリングの高度化**
   ```typescript
   // src/ml/scoring.ts
   // - 機械学習モデルの統合
   // - 重み係数の学習
   // - レコメンデーションエンジン
   ```

4. **YAMLベースのルール管理**
   ```yaml
   # rules/risk_rules.yml
   # - 買取条件ルール
   # - 法規制ルール
   # - エリアルール
   ```

### アーキテクチャ推奨

1. **マイクロサービス化の検討**
   - リスク判定エンジンを独立したWorkerに分離
   - 外部API統合をバックグラウンドジョブ化
   - キャッシュ戦略の導入（Cloudflare KV）

2. **データパイプラインの構築**
   - 外部データソースの定期取得
   - データの正規化と保存（D1 Database）
   - APIレスポンスのキャッシング

3. **監視・ログの強化**
   - 外部API呼び出しの監視
   - リスク判定の精度トラッキング
   - エラーハンドリングの強化

---

## 📝 結論

### 実装済み機能の評価
現在の実装（v3.32.0）は、**基本的な案件管理・OCR・コミュニケーション機能については非常に充実**しています（50/50機能実装完了）。

### 未実装機能の重要性
しかし、仕様書で要求されている**高度な法規制チェック・外部データ統合・AI学習機能**については、ほとんど未実装または部分実装にとどまっています。

### 推奨アクション
1. **Phase 1**: 国交省API・ハザードマップの統合（3-4週間）
2. **Phase 2**: AI学習機能・エリア分析の実装（2-3週間）
3. **Phase 3**: UX改善・自動化機能の追加（1-2週間）

### 現状の強み
- ✅ 堅牢な認証・セキュリティ
- ✅ 高度なOCR機能（GPT-4 Vision）
- ✅ リアルタイムコミュニケーション
- ✅ 包括的な案件管理

### 改善の余地
- ❌ 外部API統合（国交省、NLNI、ハザードマップ）
- ❌ 高度な法規制判定エンジン
- ❌ AI学習・レコメンデーション機能
- ❌ Google Workspace統合

---

**次のステップ**: ChatGPT/Codexでのボタンクリック問題の解決後、Phase 1の外部API統合から着手することを推奨します。
