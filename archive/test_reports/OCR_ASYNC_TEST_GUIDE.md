# OCR非同期処理 テストガイド

## v3.9.0: OCR完全非同期化 実装完了

### 実装内容

1. **新しいAPIエンドポイント: `/api/ocr-jobs`**
   - `POST /api/ocr-jobs`: OCRジョブを作成（即座にジョブIDを返却）
   - `GET /api/ocr-jobs/:jobId`: ジョブの進捗とステータスを取得
   - `GET /api/ocr-jobs`: ユーザーの全ジョブ一覧を取得
   - `DELETE /api/ocr-jobs/:jobId`: ジョブを削除

2. **ポーリングベースの進捗監視**
   - フロントエンドが1秒ごとにジョブステータスをポーリング
   - リアルタイムで処理中のファイル数、進捗パーセンテージを更新
   - 推定残り時間（ETA）を表示

3. **リトライ機能の完成**
   - `lastUploadedFiles`変数にアップロードされたファイルを保存
   - エラー時に「再試行」ボタンで同じファイルを再送信可能

4. **タイムアウト対策**
   - Cloudflare Workersの10ms CPU制限を回避
   - バックグラウンドで`c.executionCtx.waitUntil()`を使用して非同期処理
   - 最大2分間のポーリング（120秒）

### テスト手順

#### テストケース1: 単一ファイル（小）
1. 公開URL: https://3000-ihv36ugifcfle3x85cun1-5c13a017.sandbox.novita.ai
2. ログイン後、「新規案件作成」に移動
3. 「物件概要書.pdf」（1ファイル）をアップロード
4. **期待結果**:
   - ジョブが作成され、ポーリング開始
   - 進捗バーが0% → 100%に更新
   - 1ファイル完了後、抽出データが表示される
   - タイムアウトエラーが発生しない

#### テストケース2: 複数ファイル（中）
1. 「納税証明書.jpg」+「物件概要書.pdf」（2ファイル）をアップロード
2. **期待結果**:
   - 進捗バーが「0/2完了」→「1/2完了」→「2/2完了」と更新
   - 各ファイルのステータスが「待機中」→「処理中」→「完了」に変化
   - 推定残り時間が表示される

#### テストケース3: 複数ファイル（大）
1. 5-6ファイルを同時アップロード
2. **期待結果**:
   - すべてのファイルが順次処理される
   - タイムアウトせずに完了する
   - 最終的に統合されたデータが表示される

#### テストケース4: エラーリトライ
1. わざと処理に失敗するファイル（または一時的なネットワークエラー）
2. エラーセクションの「再試行」ボタンをクリック
3. **期待結果**:
   - 同じファイルで再度OCRジョブが作成される
   - 処理が再開される

### 技術詳細

#### バックエンド（`src/routes/ocr-jobs.ts`）

```typescript
// ジョブ作成
POST /api/ocr-jobs
- FormDataから全ファイルを受け取る
- ocr_jobsテーブルにジョブレコードを作成（status: 'pending'）
- バックグラウンドでprocessOCRJob()を実行
- すぐにjob_idを返却

// 進捗取得
GET /api/ocr-jobs/:jobId
- job_idからocr_jobsテーブルを検索
- status, processed_files, total_files, extracted_dataを返却
```

#### フロントエンド（`src/index.tsx`）

```javascript
// processMultipleOCR関数の変更
1. FormDataを作成し、POST /api/ocr-jobsでジョブを作成
2. 返却されたjob_idを使用してポーリング開始
3. 1秒ごとにGET /api/ocr-jobs/:jobIdで進捗を取得
4. status === 'completed'になったら結果を表示
5. status === 'failed'の場合はエラー表示
6. 最大120秒でタイムアウト
```

### デバッグ用ログ

```bash
# PM2ログを確認
pm2 logs webapp --nostream

# D1データベースでジョブを確認
cd /home/user/webapp
npx wrangler d1 execute real-estate-200units-db --local --command="SELECT * FROM ocr_jobs ORDER BY created_at DESC LIMIT 10"
```

### 既知の制約

1. **Cloudflare Workersの制限**:
   - CPU時間: 10ms（free）/ 30ms（paid）
   - メモリ: 128MB
   - リクエストサイズ: 100MB

2. **OpenAI API制限**:
   - 1リクエストあたりの最大トークン数: 16,385トークン
   - 画像サイズ: 最大20MB（base64エンコード後）

3. **ポーリング制限**:
   - 最大2分間のポーリング
   - 1秒間隔でステータス取得

### 次回実装予定

1. **WebSocket対応**（Cloudflare Durable Objectsを使用）
2. **バッチ処理最適化**（並列処理）
3. **進捗状況の永続化**（ブラウザリロード後も継続）
4. **ジョブキャンセル機能**
5. **ジョブ履歴管理UI**

## テスト結果記録欄

### テスト1: 物件概要書PDF（1枚）
- **日時**: ___________
- **結果**: [ ] 成功 [ ] エラー
- **処理時間**: _______秒
- **備考**: 

### テスト2: JPG + PDF（2枚）
- **日時**: ___________
- **結果**: [ ] 成功 [ ] エラー
- **処理時間**: _______秒
- **備考**: 

### テスト3: 複数ファイル（5-6枚）
- **日時**: ___________
- **結果**: [ ] 成功 [ ] エラー
- **処理時間**: _______秒
- **備考**: 

### エラーパターン分析
- **3回中エラー回数**: ___ / 3
- **エラー発生箇所**: 
- **推定原因**: 

## 公開URL
https://3000-ihv36ugifcfle3x85cun1-5c13a017.sandbox.novita.ai

## テスト実施者への注意事項

1. **ファイルサイズ**: 各ファイルは10MB以下にしてください
2. **ファイル形式**: PNG、JPG、JPEG、WEBP、PDF のみ対応
3. **ファイル数**: 一度に最大10ファイルまで
4. **タイムアウト**: 2分以上かかる場合は自動的にタイムアウトします
5. **ネットワーク**: 安定したネットワーク環境でテストしてください

## トラブルシューティング

### エラー: "OCR処理がタイムアウトしました"
- **原因**: ファイルが大きすぎる、または処理に2分以上かかっている
- **対策**: ファイル数を減らす、ファイルサイズを圧縮する

### エラー: "OpenAI API Keyが設定されていません"
- **原因**: 環境変数が未設定
- **対策**: wrangler secret put OPENAI_API_KEY を実行

### エラー: "ジョブが見つかりません"
- **原因**: ジョブIDが無効、またはDBの問題
- **対策**: D1データベースの接続を確認

### 進捗バーが90%で止まる
- **原因**: ポーリング処理のバグ、またはバックエンドエラー
- **対策**: PM2ログを確認（pm2 logs webapp --nostream）
