# 📘 管理者向け使用説明書

## 目次
1. [管理者の役割](#管理者の役割)
2. [ログイン方法](#ログイン方法)
3. [ダッシュボード](#ダッシュボード)
4. [案件管理](#案件管理)
5. [ユーザー管理](#ユーザー管理)
6. [システム設定](#システム設定)
7. [レポート・分析](#レポート分析)
8. [トラブルシューティング](#トラブルシューティング)

---

## 管理者の役割

### 権限と責任
管理者（ADMIN）は、システム全体の管理・運用を担当します。

**主な権限**:
- ✅ 全ての案件の閲覧・編集・削除
- ✅ ユーザー（買側・売側）の追加・編集・削除
- ✅ システム設定の変更
- ✅ レポート・分析データの閲覧
- ✅ バックアップ・復元の実行
- ✅ 監査ログの確認

**主な責任**:
- 案件の進捗管理とモニタリング
- ユーザーアカウントの管理
- 買側と売側のマッチング支援
- システムの安定稼働の監視
- データのバックアップ管理

---

## ログイン方法

### ステップ1: ログインページにアクセス
```
URL: https://real-estate-200units-v2.pages.dev/
```

### ステップ2: 管理者アカウントでログイン
- **メールアドレス**: admin@200units.com（例）
- **パスワード**: 管理者用パスワード
- **ロール**: ADMIN

### ステップ3: ダッシュボードへ自動遷移
ログイン成功後、自動的にダッシュボードに遷移します。

---

## ダッシュボード

### 概要
ダッシュボードでは、システム全体のKPIと最近の案件を一覧で確認できます。

### KPIカード

#### 1. 総案件数
- 表示内容: 登録されている全案件の総数
- 用途: システム全体の案件ボリュームを把握

#### 2. 進行中
- 表示内容: ステータスが「新規」「レビュー中」の案件数
- 用途: アクティブな案件数を把握
- アクション: この数値が多い場合は、優先的に対応が必要

#### 3. 回答済み
- 表示内容: ステータスが「回答済み」の案件数
- 用途: 買側からの回答待ちの案件を把握
- アクション: 回答内容を確認し、次のステップへ進める

#### 4. 完了
- 表示内容: ステータスが「終了」の案件数
- 用途: 成約または不成立で終了した案件数
- アクション: 成約率の分析に活用

### 最近の案件
- 表示件数: 最新5件
- 表示情報: 案件名、ステータス、所在地、作成日
- アクション: クリックで案件詳細へ遷移

### ナビゲーション
- **案件一覧**: 全案件の一覧ページへ移動
- **APIドキュメント**: API仕様書の確認

---

## 案件管理

### 案件一覧画面

#### 画面の構成
```
[フィルター・検索エリア]
- ステータスフィルター
- 検索ボックス
- 並び順選択
- リセットボタン

[案件リスト]
- 案件カード（複数表示）
```

#### フィルター機能

**ステータスフィルター**:
- 全て: 全ステータスの案件を表示
- 新規: 買側からの新規問い合わせ
- レビュー中: 売側が内容を確認中
- 回答済み: 売側から回答済み
- 終了: 成約または不成立で終了

**検索機能**:
- 案件名で検索
- 所在地で検索
- リアルタイム検索（入力と同時に結果が更新）

**並び順**:
- 作成日（新しい順）: デフォルト
- 作成日（古い順）: 古い案件を確認
- 更新日（新しい順）: 最近更新された案件

#### 管理者の案件管理業務フロー

**1. 新規案件の受付**
```
買側から問い合わせ
  ↓
[新規] ステータスで登録
  ↓
管理者が内容を確認
  ↓
売側に通知・レビュー依頼
  ↓
[レビュー中] に変更
```

**2. レビュー中の案件管理**
```
売側がレビュー実施
  ↓
不足情報がある場合
  → 買側に追加情報を依頼
  → [新規] に戻す

情報が十分な場合
  → 売側が回答作成
  → [回答済み] に変更
```

**3. 回答済みの案件フォロー**
```
[回答済み] ステータス
  ↓
買側が回答内容を確認
  ↓
交渉・条件調整
  ↓
成約 → [終了] (成約)
不成立 → [終了] (不成立)
```

### 案件詳細画面

#### タブ構成

**基本情報タブ**:
- 所在地、最寄り駅、徒歩分数
- 土地面積、用途地域
- 建蔽率、容積率、高度地区、防火地域
- 道路情報、現況
- 希望価格
- 備考

**ファイルタブ**（開発中）:
- 登記簿謄本
- 測量図
- 現況写真
- 契約書類

**メッセージタブ**（開発中）:
- 買側・売側・管理者間のコミュニケーション
- ファイル添付
- @メンション機能

#### 管理者の確認ポイント

**新規案件の確認**:
1. 必須情報が全て入力されているか
2. 希望価格が市場相場と大きく乖離していないか
3. 土地の用途地域と買側の開発計画が合致しているか
4. 法的制限（高度地区、防火地域等）の確認

**レビュー中の確認**:
1. 売側からの質問に対する回答内容
2. 追加で必要な情報の洗い出し
3. 買側・売側間の認識のズレの確認

**回答済みの確認**:
1. 売側からの回答内容の妥当性
2. 買側が意思決定できる情報が揃っているか
3. 次のステップ（現地確認、条件交渉等）の設定

---

## ユーザー管理

### ユーザーの種類

**1. 管理者（ADMIN）**
- 役割: システム管理・案件全体の統括
- 権限: 全機能へのアクセス

**2. 買側ユーザー（AGENT - 買側）**
- 役割: 土地の購入希望者
- 権限: 案件の登録・自社案件の閲覧・メッセージ

**3. 売側ユーザー（AGENT - 売側）**
- 役割: 土地の売却希望者
- 権限: 割り当てられた案件の閲覧・回答・メッセージ

### ユーザーの追加（API使用）

現在、ユーザー追加はAPI経由で実行します。

```bash
# ログインしてJWTトークンを取得
curl -X POST https://real-estate-200units-v2.pages.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@200units.com", "password": "YOUR_PASSWORD"}' \
  > token.json

# トークンを環境変数に設定
export TOKEN=$(cat token.json | jq -r '.token')

# 新規ユーザーを追加
curl -X POST https://real-estate-200units-v2.pages.dev/api/auth/register \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "email": "buyer@example.com",
    "password": "SecurePassword123",
    "name": "買側担当者",
    "role": "AGENT",
    "company_name": "株式会社買側不動産"
  }'
```

### ユーザー情報の確認

```bash
# 自分のユーザー情報を確認
curl https://real-estate-200units-v2.pages.dev/api/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

---

## システム設定

### 通知設定

**管理者向け通知**:
- 新規案件登録時の通知
- 案件ステータス変更時の通知
- 回答期限超過のアラート
- システムエラーの通知

**設定方法**:
```
1. ダッシュボード右上のユーザーメニュー
2. 「設定」を選択
3. 「通知設定」タブ
4. 通知種別ごとにON/OFF設定
5. メール通知 / プッシュ通知を選択
6. 「保存」ボタン
```

### バックアップ設定

**自動バックアップ**:
- 頻度: 毎日（デフォルト）
- 保存先: Cloudflare R2
- 保持期間: 30日（デフォルト）

**手動バックアップ**（API使用）:
```bash
# バックアップ作成
curl -X POST https://real-estate-200units-v2.pages.dev/api/backup/create \
  -H "Authorization: Bearer $TOKEN"

# バックアップ一覧取得
curl https://real-estate-200units-v2.pages.dev/api/backup/list \
  -H "Authorization: Bearer $TOKEN"
```

---

## レポート・分析

### KPIダッシュボード（API使用）

```bash
# KPIダッシュボードデータ取得
curl https://real-estate-200units-v2.pages.dev/api/analytics/kpi/dashboard \
  -H "Authorization: Bearer $TOKEN"
```

**表示データ**:
- 総案件数
- ステータス別案件数
- 今月の新規案件数
- 今月の成約件数
- アクティブユーザー数
- 平均応答時間

### 月次レポート（API使用）

```bash
# 月次レポート取得
curl https://real-estate-200units-v2.pages.dev/api/analytics/reports/monthly?month=2025-11 \
  -H "Authorization: Bearer $TOKEN"
```

**レポート内容**:
- 月間新規案件数
- 月間成約件数
- 成約率
- 平均案件期間
- ユーザー活動状況

### データエクスポート（API使用）

```bash
# CSV形式でエクスポート
curl https://real-estate-200units-v2.pages.dev/api/analytics/export/deals?format=csv \
  -H "Authorization: Bearer $TOKEN" \
  > deals_export.csv

# JSON形式でエクスポート
curl https://real-estate-200units-v2.pages.dev/api/analytics/export/deals?format=json \
  -H "Authorization: Bearer $TOKEN" \
  > deals_export.json
```

---

## トラブルシューティング

### よくある問題

#### 1. ユーザーがログインできない

**原因と対処**:
- パスワードが間違っている
  → パスワードリセットを実施（OPERATIONS_MANUAL.md参照）
- アカウントが無効化されている
  → データベースで`is_active`フラグを確認・有効化
- メールアドレスが間違っている
  → 正しいメールアドレスを確認

#### 2. 案件が表示されない

**原因と対処**:
- フィルターが適用されている
  → リセットボタンでフィルターをクリア
- データベース接続エラー
  → ヘルスチェックAPI（/api/health）で確認
- 権限不足
  → 管理者はすべての案件を表示可能、権限を確認

#### 3. 通知が届かない

**原因と対処**:
- 通知設定がOFFになっている
  → 設定画面で通知をONに変更
- メールアドレスが間違っている
  → ユーザー情報でメールアドレスを確認
- Resend API制限超過
  → 無料プラン：月3,000通、1日100通の制限を確認

#### 4. システムが重い・遅い

**原因と対処**:
- データベースに大量のレコード
  → 古い案件をアーカイブ
- ネットワーク遅延
  → ブラウザの開発者ツールでネットワークタブを確認
- Cloudflare Workersの制限
  → CPU時間制限（無料：10ms、有料：50ms）を確認

### 管理者向けトラブルシューティングツール

**ヘルスチェック**:
```bash
curl https://real-estate-200units-v2.pages.dev/api/health
```

**APIバージョン確認**:
```bash
curl https://real-estate-200units-v2.pages.dev/api/version
```

**ログ確認**（Cloudflare Dashboard）:
```
1. Cloudflareダッシュボードにログイン
2. Workers & Pages → real-estate-200units-v2
3. Logs タブで確認
```

**エラートラッキング**（Sentry）:
```
1. Sentry.ioにログイン
2. プロジェクトを選択
3. Issues タブでエラーを確認
```

---

## 管理者のベストプラクティス

### 日次業務
- [ ] ダッシュボードでKPIを確認
- [ ] 新規案件をレビュー
- [ ] レビュー中・回答済み案件の進捗確認
- [ ] 通知・アラートの確認

### 週次業務
- [ ] ユーザー活動状況の確認
- [ ] 案件の進捗レビュー
- [ ] 長期滞留案件のフォローアップ
- [ ] システムログの確認

### 月次業務
- [ ] 月次レポートの作成・分析
- [ ] 成約率・応答時間の分析
- [ ] バックアップの確認
- [ ] ユーザーフィードバックのレビュー

### セキュリティ対策
- 強力なパスワードを使用（12文字以上、英数字記号混在）
- パスワードを定期的に変更（3ヶ月ごと推奨）
- 不審なアクティビティを監視
- ユーザーアカウントの定期監査

---

## サポート・お問い合わせ

### ドキュメント
- **運用マニュアル**: `OPERATIONS_MANUAL.md`
- **APIドキュメント**: https://real-estate-200units-v2.pages.dev/api/docs

### 技術サポート
- **GitHub Issues**: https://github.com/koki-187/200/issues
- **Email**: tech-support@200units.com（例）

---

**最終更新**: 2025-11-17
**対象ロール**: 管理者（ADMIN）
**バージョン**: v1.0
