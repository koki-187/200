# v3.153.8 Critical Fix - JavaScript Syntax Error

## 根本原因

`/deals/new`ページのJavaScriptに構文エラーがあり、**メインscriptタグ全体が実行されていませんでした**。

### 具体的な問題

`src/index.tsx`の9269行目と9276行目で、alert文字列内の改行`\n`が正しくエスケープされていませんでした:

```javascript
// 誤: TSXテンプレートリテラル内で\nがそのまま出力される
alert('❌ エラー\n\n包括チェック機能が読み込まれていません。ページを再読み込みしてください。');

// 正: \nを\\nにダブルエスケープ
alert('❌ エラー\\n\\n包括チェック機能が読み込まれていません。ページを再読み込みしてください。');
```

### 影響範囲

この構文エラーにより:
1. メインscriptタグが実行されない
2. `token`変数が定義されない
3. `loadSellers()`関数が定義されない
4. セラードロップダウンが空白のまま
5. その他の初期化処理も実行されない

## 修正内容

### ファイル: `src/index.tsx`

**Line 9269:**
```javascript
// Before
alert('❌ エラー\n\n包括チェック機能が読み込まれていません。ページを再読み込みしてください。');

// After
alert('❌ エラー\\n\\n包括チェック機能が読み込まれていません。ページを再読み込みしてください。');
```

**Line 9276:**
```javascript
// Before
alert('❌ エラー\n\nリスクチェック中にエラーが発生しました。\n\n' + error.message);

// After
alert('❌ エラー\\n\\nリスクチェック中にエラーが発生しました。\\n\\n' + error.message);
```

## 検証

### Before (v3.153.7)
```
Playwright Console Log:
- [EMERGENCY] typeof loadSellers: undefined
- [ERROR] loadSellers is not a function!
- Invalid or unexpected token (Page Error)
```

### After (v3.153.8)
```
Playwright Console Log:
- [CRITICAL DEBUG] SCRIPT START v3.149.1
- [Init] INITIALIZE PAGE (deals/new)
- ✅ No "Invalid or unexpected token" error
- ✅ All initialization logs present
```

## デプロイ情報

- **Version**: v3.153.8
- **Deployment URL**: https://933741bf.real-estate-200units-v2.pages.dev
- **Commit**: a0d799b
- **Date**: 2025-12-08

## 次のステップ

ユーザーが以下を確認する必要があります:

1. **正しいURLでアクセス**: `https://933741bf.real-estate-200units-v2.pages.dev`
2. **キャッシュクリア**: Ctrl+Shift+R (Windows/Linux) または Cmd+Shift+R (Mac)
3. **ログイン**: `navigator-187@docomo.ne.jp` / `kouki187`
4. **新規案件作成ページ**: `/deals/new`
5. **セラードロップダウンを確認**: 4人のAGENTユーザーが表示されるはず

## 補足: 緊急修正スクリプト

v3.153.7で追加した`[EMERGENCY] Force loadSellers`スクリプトは、v3.153.8でも残っていますが、今回の修正により不要になる可能性があります。しかし、フェイルセーフとして残しておきます。

## ログ例（期待される動作）

ユーザーがログイン後に`/deals/new`ページにアクセスした場合:

```
[CRITICAL DEBUG] SCRIPT START v3.149.1
[CRITICAL DEBUG] Token retrieved: true
[Init] INITIALIZE PAGE (deals/new)
[Init] Starting delayed initialization...
[Sellers] ========== START (Retry: 0 ) ==========
[Sellers] Token: exists (eyJ0eXAiOiJKV1QiL...)
[Sellers] seller_id element found
[Sellers] Calling API: /api/auth/users
[Sellers] API Response: { users: [...] }
[Sellers] Filtered sellers: 4 AGENT users found
[Sellers] Added option: 本番テスト担当者 (本番テスト不動産)
[Sellers] Added option: テスト担当者 (不動産仲介株式会社)
[Sellers] Added option: 田中太郎 (不動産ABC株式会社)
[Sellers] Added option: 佐藤花子 (株式会社XYZ不動産)
[Sellers] ✅ Successfully loaded 4 sellers
```

---

**重要**: ユーザーには必ず**最新のURL**でテストしてもらう必要があります。古いデプロイ(例: `c363a668`, `a23cb7c1`, `b47a210e`)では、この修正が反映されていません。
