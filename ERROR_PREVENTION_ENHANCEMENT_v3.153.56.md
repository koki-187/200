# ğŸ›¡ï¸ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ  - ã‚¨ãƒ©ãƒ¼å¯¾å¿œå¼·åŒ– & å†ç™ºé˜²æ­¢ç­–

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v3.153.56  
**ä½œæˆæ—¥**: 2025-12-11  
**ç›®çš„**: 100ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆã§ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œã¨æ½œåœ¨çš„ã‚¨ãƒ©ãƒ¼è¦å› ã¸ã®å¯¾å¿œ

---

## ğŸ“‹ æ½œåœ¨çš„ã‚¨ãƒ©ãƒ¼è¦å› ã®åˆ†æ

### 1. **ç¾åœ¨æœªå¯¾å¿œã®ã‚¨ãƒ©ãƒ¼è¦å› **

100ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆã®çµæœã‚’åˆ†æã—ã€ä»¥ä¸‹ã®æ½œåœ¨çš„ã‚¨ãƒ©ãƒ¼è¦å› ã‚’ç‰¹å®šã—ã¾ã—ãŸï¼š

#### ğŸ”´ **é«˜ãƒªã‚¹ã‚¯è¦å› **ï¼ˆå³åº§ã®å¯¾å¿œå¿…è¦ï¼‰

| # | ã‚¨ãƒ©ãƒ¼è¦å›  | å½±éŸ¿ç¯„å›² | ç¾åœ¨ã®å¯¾å¿œçŠ¶æ³ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
|---|-----------|---------|-------------|------------|
| 1 | **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­æ™‚ã®å®Œå…¨åœæ­¢** | å…¨æ©Ÿèƒ½ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ã¿ | ğŸ”´ é«˜ |
| 2 | **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã«ã‚ˆã‚‹æ®µéšçš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹** | å…¨æ©Ÿèƒ½ | æœªå¯¾å¿œ | ğŸ”´ é«˜ |
| 3 | **åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ€¥å¢—æ™‚ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼** | APIå…¨èˆ¬ | æœªå¯¾å¿œ | ğŸ”´ é«˜ |
| 4 | **CORSè¨­å®šãƒŸã‚¹ã«ã‚ˆã‚‹APIå‘¼ã³å‡ºã—å¤±æ•—** | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | éƒ¨åˆ†å¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 5 | **ç’°å¢ƒå¤‰æ•°ã®æœªè¨­å®š/èª¤è¨­å®š** | æ©Ÿèƒ½å€‹åˆ¥ | éƒ¨åˆ†å¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 6 | **ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆ** | ãƒ“ãƒ«ãƒ‰ | æœªå¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 7 | **D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®¹é‡ä¸Šé™åˆ°é”** | ãƒ‡ãƒ¼ã‚¿ä¿å­˜ | æœªå¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 8 | **R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡ä¸Šé™åˆ°é”** | ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ | éƒ¨åˆ†å¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 9 | **ãƒ–ãƒ©ã‚¦ã‚¶ã®äº’æ›æ€§å•é¡Œ** | UIå…¨èˆ¬ | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |
| 10 | **ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã®è¡¨ç¤ºå´©ã‚Œ** | UIå…¨èˆ¬ | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |

#### ğŸŸ¡ **ä¸­ãƒªã‚¹ã‚¯è¦å› **ï¼ˆè¨ˆç”»çš„ãªå¯¾å¿œå¿…è¦ï¼‰

| # | ã‚¨ãƒ©ãƒ¼è¦å›  | å½±éŸ¿ç¯„å›² | ç¾åœ¨ã®å¯¾å¿œçŠ¶æ³ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
|---|-----------|---------|-------------|------------|
| 11 | **å¤–éƒ¨APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é** | ç‰©ä»¶æƒ…å ±è£œè¶³/ãƒªã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯ | éƒ¨åˆ†å¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 12 | **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡è¶…é** | èªè¨¼ | æœªå¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 13 | **é•·æ™‚é–“æ“ä½œã«ã‚ˆã‚‹CSRFãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹** | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | æœªå¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 14 | **å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬å‡¦ç†ã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | ãƒãƒƒãƒå‡¦ç† | éƒ¨åˆ†å¯¾å¿œ | ğŸŸ¡ ä¸­ |
| 15 | **ä¸¦è¡Œç·¨é›†ã«ã‚ˆã‚‹ç«¶åˆ** | æ¡ˆä»¶ç·¨é›† | æœªå¯¾å¿œ | ğŸŸ¡ ä¸­ |

#### ğŸŸ¢ **ä½ãƒªã‚¹ã‚¯è¦å› **ï¼ˆç›£è¦–ã®ã¿ï¼‰

| # | ã‚¨ãƒ©ãƒ¼è¦å›  | å½±éŸ¿ç¯„å›² | ç¾åœ¨ã®å¯¾å¿œçŠ¶æ³ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
|---|-----------|---------|-------------|------------|
| 16 | **ç‰¹æ®Šæ–‡å­—å…¥åŠ›ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼** | ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬ | å¯¾å¿œæ¸ˆã¿ | ğŸŸ¢ ä½ |
| 17 | **ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®æœªå®Ÿè£…** | UI | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |
| 18 | **å°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å´©ã‚Œ** | UI | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |
| 19 | **ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹** | UI | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |
| 20 | **å¤šè¨€èªå¯¾å¿œã®ä¸å®Œå…¨** | UI | æœªå¯¾å¿œ | ğŸŸ¢ ä½ |

---

## ğŸ”§ å¼·åŒ–ç­–ã®å®Ÿè£…è¨ˆç”»

### Phase 1: é«˜ãƒªã‚¹ã‚¯è¦å› ã¸ã®å³åº§ã®å¯¾å¿œï¼ˆæœ¬ãƒãƒ£ãƒƒãƒˆï¼‰

#### 1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­æ™‚ã®å®Œå…¨åœæ­¢å¯¾ç­–**

**å•é¡Œ**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ã¿ã®å¯¾å¿œã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®Œå…¨æ–­çµ¶æ™‚ã«å¾©æ—§ã—ãªã„

**å¼·åŒ–å†…å®¹**:
```typescript
// æ–°è¦: src/middleware/network-resilience.ts
export const networkResilienceMiddleware = async (c: Context, next: Function) => {
  const maxRetries = 3;
  let attempt = 0;
  
  while (attempt < maxRetries) {
    try {
      await next();
      return;
    } catch (error: any) {
      attempt++;
      
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®åˆ¤å®š
      if (error.name === 'NetworkError' || error.code === 'ECONNREFUSED') {
        console.warn(`[Network Resilience] Retry ${attempt}/${maxRetries}`);
        
        // Exponential backoff
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        
        if (attempt >= maxRetries) {
          // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆ
          return c.json({
            error: 'Network unavailable',
            offline_mode: true,
            message: 'ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚æ¥ç¶šãŒå¾©æ—§æ¬¡ç¬¬ã€è‡ªå‹•çš„ã«å†æ¥ç¶šã—ã¾ã™ã€‚',
            retry_after: 60
          }, 503);
        }
      } else {
        throw error;
      }
    }
  }
};
```

#### 2. **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œçŸ¥ã¨è‡ªå‹•å›å¾©**

**å•é¡Œ**: é•·æ™‚é–“é‹ç”¨ã§ãƒ¡ãƒ¢ãƒªãŒå¾ã€…ã«å¢—åŠ ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹

**å¼·åŒ–å†…å®¹**:
```typescript
// æ–°è¦: src/middleware/memory-monitor.ts
export class MemoryMonitor {
  private static instance: MemoryMonitor;
  private memoryThreshold = 0.85; // 85%ã§ã‚¢ãƒ©ãƒ¼ãƒˆ
  
  static getInstance() {
    if (!this.instance) {
      this.instance = new MemoryMonitor();
    }
    return this.instance;
  }
  
  checkMemory() {
    // Cloudflare Workersã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’ç›£è¦–
    const used = (performance as any).memory?.usedJSHeapSize || 0;
    const limit = (performance as any).memory?.jsHeapSizeLimit || 128 * 1024 * 1024;
    
    const usage = used / limit;
    
    if (usage > this.memoryThreshold) {
      console.error(`[Memory Monitor] High memory usage: ${(usage * 100).toFixed(2)}%`);
      
      // è‡ªå‹•ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¿ƒé€²
      if (global.gc) {
        global.gc();
      }
      
      // ç®¡ç†è€…ã«é€šçŸ¥
      this.notifyAdmin('High memory usage detected', { usage, used, limit });
      
      return false;
    }
    
    return true;
  }
  
  async notifyAdmin(message: string, details: any) {
    // ç®¡ç†è€…ã¸ã®é€šçŸ¥å®Ÿè£…
    console.warn(`[Admin Alert] ${message}`, details);
  }
}
```

#### 3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è‡ªå‹•ç®¡ç†**

**å•é¡Œ**: åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ€¥å¢—æ™‚ã«APIå‘¼ã³å‡ºã—ãŒå¤±æ•—

**å¼·åŒ–å†…å®¹**:
```typescript
// æ–°è¦: src/middleware/rate-limiter-enhanced.ts
export class AdaptiveRateLimiter {
  private queue: Array<() => Promise<any>> = [];
  private processing = false;
  private currentRate = 10; // åˆæœŸãƒ¬ãƒ¼ãƒˆ: 10req/ç§’
  private minRate = 1;
  private maxRate = 100;
  
  async execute<T>(fn: () => Promise<T>): Promise<T> {
    return new Promise((resolve, reject) => {
      this.queue.push(async () => {
        try {
          const result = await fn();
          // æˆåŠŸæ™‚ã¯ãƒ¬ãƒ¼ãƒˆã‚’ä¸Šã’ã‚‹
          this.increaseRate();
          resolve(result);
        } catch (error: any) {
          // 429ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¬ãƒ¼ãƒˆã‚’ä¸‹ã’ã‚‹
          if (error.status === 429) {
            this.decreaseRate();
            // ãƒªãƒˆãƒ©ã‚¤
            this.queue.unshift(() => fn().then(resolve).catch(reject));
          } else {
            reject(error);
          }
        }
      });
      
      this.processQueue();
    });
  }
  
  private async processQueue() {
    if (this.processing || this.queue.length === 0) return;
    
    this.processing = true;
    
    while (this.queue.length > 0) {
      const task = this.queue.shift();
      if (task) {
        await task();
        // ãƒ¬ãƒ¼ãƒˆã«åŸºã¥ã„ãŸå¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, 1000 / this.currentRate));
      }
    }
    
    this.processing = false;
  }
  
  private increaseRate() {
    this.currentRate = Math.min(this.currentRate * 1.1, this.maxRate);
  }
  
  private decreaseRate() {
    this.currentRate = Math.max(this.currentRate * 0.5, this.minRate);
    console.warn(`[Rate Limiter] Rate decreased to ${this.currentRate} req/s`);
  }
}
```

#### 4. **ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼å¼·åŒ–**

**å•é¡Œ**: å¿…é ˆç’°å¢ƒå¤‰æ•°ã®æœªè¨­å®šã§ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼

**å¼·åŒ–å†…å®¹**:
```typescript
// æ–°è¦: src/utils/env-validator.ts
export interface EnvConfig {
  JWT_SECRET: string;
  MLIT_API_KEY?: string;
  DB: D1Database;
  KV: KVNamespace;
  R2: R2Bucket;
}

export function validateEnv(env: any): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  // å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
  if (!env.JWT_SECRET) {
    errors.push('JWT_SECRET is not configured');
  }
  
  if (!env.DB) {
    errors.push('D1 Database (DB) is not bound');
  }
  
  if (!env.KV) {
    errors.push('KV Namespace (KV) is not bound');
  }
  
  if (!env.R2) {
    errors.push('R2 Bucket (R2) is not bound');
  }
  
  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã®è­¦å‘Š
  if (!env.MLIT_API_KEY) {
    console.warn('[Env Validator] MLIT_API_KEY is not set - some features may be limited');
  }
  
  return {
    valid: errors.length === 0,
    errors
  };
}

// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒã‚§ãƒƒã‚¯
export function initEnvCheck(env: any) {
  const validation = validateEnv(env);
  
  if (!validation.valid) {
    console.error('[Env Validator] Configuration errors:', validation.errors);
    throw new Error(`Environment validation failed: ${validation.errors.join(', ')}`);
  }
  
  console.log('[Env Validator] âœ… All required environment variables are configured');
}
```

---

### Phase 2: å†ç™ºé˜²æ­¢ç­–ã®å¼·åŒ–

#### 1. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ **

**å®Ÿè£…å†…å®¹**:
```typescript
// æ–°è¦: src/utils/error-logger.ts
export interface ErrorLog {
  id: string;
  timestamp: string;
  level: 'error' | 'warning' | 'info';
  category: string;
  message: string;
  stack?: string;
  context?: any;
  user_id?: string;
  recovery_attempted: boolean;
  recovery_success: boolean;
}

export class ErrorLogger {
  private static db: D1Database;
  
  static init(db: D1Database) {
    this.db = db;
  }
  
  static async log(error: ErrorLog) {
    try {
      await this.db.prepare(`
        INSERT INTO error_logs (
          id, timestamp, level, category, message, stack, context,
          user_id, recovery_attempted, recovery_success
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        error.id,
        error.timestamp,
        error.level,
        error.category,
        error.message,
        error.stack || null,
        JSON.stringify(error.context || {}),
        error.user_id || null,
        error.recovery_attempted ? 1 : 0,
        error.recovery_success ? 1 : 0
      ).run();
      
      console.log(`[Error Logger] Logged error: ${error.id}`);
    } catch (err) {
      console.error('[Error Logger] Failed to log error:', err);
    }
  }
  
  static async getRecentErrors(limit = 100) {
    try {
      const results = await this.db.prepare(`
        SELECT * FROM error_logs
        ORDER BY timestamp DESC
        LIMIT ?
      `).bind(limit).all();
      
      return results.results;
    } catch (err) {
      console.error('[Error Logger] Failed to retrieve errors:', err);
      return [];
    }
  }
  
  static async getErrorStats() {
    try {
      const stats = await this.db.prepare(`
        SELECT 
          category,
          level,
          COUNT(*) as count,
          SUM(CASE WHEN recovery_success = 1 THEN 1 ELSE 0 END) as recovered,
          AVG(CASE WHEN recovery_attempted = 1 THEN recovery_success ELSE NULL END) as recovery_rate
        FROM error_logs
        WHERE timestamp >= datetime('now', '-7 days')
        GROUP BY category, level
        ORDER BY count DESC
      `).all();
      
      return stats.results;
    } catch (err) {
      console.error('[Error Logger] Failed to get stats:', err);
      return [];
    }
  }
}
```

#### 2. **äºˆé˜²çš„ç›£è¦–æ©Ÿèƒ½**

**å®Ÿè£…å†…å®¹**:
```typescript
// æ–°è¦: src/utils/proactive-monitor.ts
export class ProactiveMonitor {
  private checks: Map<string, () => Promise<boolean>> = new Map();
  private intervals: Map<string, NodeJS.Timer> = new Map();
  
  registerCheck(name: string, checkFn: () => Promise<boolean>, intervalMs = 60000) {
    this.checks.set(name, checkFn);
    
    // å®šæœŸãƒã‚§ãƒƒã‚¯ã®é–‹å§‹
    const interval = setInterval(async () => {
      try {
        const result = await checkFn();
        
        if (!result) {
          console.warn(`[Proactive Monitor] Check failed: ${name}`);
          
          // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«è¨˜éŒ²
          await ErrorLogger.log({
            id: `monitor-${name}-${Date.now()}`,
            timestamp: new Date().toISOString(),
            level: 'warning',
            category: 'proactive_monitoring',
            message: `Proactive check failed: ${name}`,
            recovery_attempted: false,
            recovery_success: false
          });
        }
      } catch (error: any) {
        console.error(`[Proactive Monitor] Error in check ${name}:`, error);
      }
    }, intervalMs);
    
    this.intervals.set(name, interval);
  }
  
  stopCheck(name: string) {
    const interval = this.intervals.get(name);
    if (interval) {
      clearInterval(interval);
      this.intervals.delete(name);
    }
  }
  
  async runAllChecks() {
    const results: Record<string, boolean> = {};
    
    for (const [name, checkFn] of this.checks.entries()) {
      try {
        results[name] = await checkFn();
      } catch (error) {
        results[name] = false;
      }
    }
    
    return results;
  }
}

// äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
export function setupDefaultChecks(monitor: ProactiveMonitor, env: any) {
  // DBãƒã‚§ãƒƒã‚¯
  monitor.registerCheck('database', async () => {
    try {
      await env.DB.prepare('SELECT 1').first();
      return true;
    } catch (error) {
      return false;
    }
  }, 60000); // 1åˆ†ã”ã¨
  
  // KVãƒã‚§ãƒƒã‚¯
  monitor.registerCheck('kv_storage', async () => {
    try {
      await env.KV.get('health_check');
      return true;
    } catch (error) {
      return false;
    }
  }, 60000);
  
  // R2ãƒã‚§ãƒƒã‚¯
  monitor.registerCheck('r2_storage', async () => {
    try {
      await env.R2.list({ limit: 1 });
      return true;
    } catch (error) {
      return false;
    }
  }, 60000);
  
  // å¤–éƒ¨APIãƒã‚§ãƒƒã‚¯
  monitor.registerCheck('external_api', async () => {
    try {
      const response = await fetch('https://nominatim.openstreetmap.org/search?q=test&format=json&limit=1', {
        headers: { 'User-Agent': 'Real-Estate-System/1.0' }
      });
      return response.ok;
    } catch (error) {
      return false;
    }
  }, 300000); // 5åˆ†ã”ã¨
}
```

#### 3. **è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ**

**å®Ÿè£…å†…å®¹**:
```typescript
// æ–°è¦: src/routes/error-report.ts
import { Hono } from 'hono';
import { ErrorLogger } from '../utils/error-logger';

const app = new Hono();

// ã‚¨ãƒ©ãƒ¼çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
app.get('/api/admin/error-report', async (c) => {
  try {
    const stats = await ErrorLogger.getErrorStats();
    const recentErrors = await ErrorLogger.getRecentErrors(50);
    
    return c.json({
      success: true,
      stats,
      recent_errors: recentErrors,
      summary: {
        total_errors: stats.reduce((sum: number, s: any) => sum + s.count, 0),
        auto_recovered: stats.reduce((sum: number, s: any) => sum + s.recovered, 0),
        recovery_rate: stats.length > 0 
          ? stats.reduce((sum: number, s: any) => sum + (s.recovery_rate || 0), 0) / stats.length
          : 0
      }
    });
  } catch (error: any) {
    console.error('[Error Report] Failed to generate report:', error);
    return c.json({
      success: false,
      error: error.message
    }, 500);
  }
});

export default app;
```

---

## ğŸ“Š å¼·åŒ–ç­–ã®å„ªå…ˆé †ä½ãƒãƒˆãƒªã‚¯ã‚¹

| å¼·åŒ–ç­– | å½±éŸ¿åº¦ | å®Ÿè£…é›£æ˜“åº¦ | å„ªå…ˆåº¦ | å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º |
|--------|--------|-----------|--------|------------|
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­å¯¾ç­– | é«˜ | ä¸­ | ğŸ”´ æœ€å„ªå…ˆ | Phase 1 |
| ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œçŸ¥ | é«˜ | é«˜ | ğŸ”´ æœ€å„ªå…ˆ | Phase 1 |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç† | é«˜ | ä¸­ | ğŸ”´ æœ€å„ªå…ˆ | Phase 1 |
| ç’°å¢ƒå¤‰æ•°æ¤œè¨¼ | ä¸­ | ä½ | ğŸŸ¡ é«˜ | Phase 1 |
| ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ² | ä¸­ | ä¸­ | ğŸŸ¡ é«˜ | Phase 2 |
| äºˆé˜²çš„ç›£è¦– | ä¸­ | ä¸­ | ğŸŸ¡ é«˜ | Phase 2 |
| è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ | ä½ | ä½ | ğŸŸ¢ ä¸­ | Phase 2 |

---

## ğŸ¯ å®Ÿè£…å¾Œã®ç›®æ¨™å€¤

| æŒ‡æ¨™ | ç¾åœ¨å€¤ | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³• |
|-----|--------|--------|---------|
| **è‡ªå‹•ä¿®å¾©ç‡** | 85% | 92%ä»¥ä¸Š | 100ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ |
| **å¹³å‡å¾©æ—§æ™‚é–“** | 15ç§’ | 10ç§’ä»¥å†… | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åˆ†æ |
| **èª¤æ¤œçŸ¥ç‡** | 3% | 1%ä»¥ä¸‹ | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ |
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼å¾©æ—§ç‡** | 70% | 95%ä»¥ä¸Š | éšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œçŸ¥ç‡** | 0% | 100% | é•·æ™‚é–“é‹ç”¨ãƒ†ã‚¹ãƒˆ |

---

## ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### error_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
-- migrations/0010_error_logs.sql
CREATE TABLE IF NOT EXISTS error_logs (
  id TEXT PRIMARY KEY,
  timestamp DATETIME NOT NULL,
  level TEXT NOT NULL CHECK(level IN ('error', 'warning', 'info')),
  category TEXT NOT NULL,
  message TEXT NOT NULL,
  stack TEXT,
  context TEXT,
  user_id TEXT,
  recovery_attempted INTEGER DEFAULT 0,
  recovery_success INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_error_logs_timestamp ON error_logs(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_error_logs_category ON error_logs(category);
CREATE INDEX IF NOT EXISTS idx_error_logs_level ON error_logs(level);
CREATE INDEX IF NOT EXISTS idx_error_logs_user_id ON error_logs(user_id);
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1 å®Ÿè£…é …ç›®

- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­å¯¾ç­–ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
- [ ] ãƒ¡ãƒ¢ãƒªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- [ ] é©å¿œçš„ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
- [ ] ç’°å¢ƒå¤‰æ•°æ¤œè¨¼æ©Ÿèƒ½å®Ÿè£…
- [ ] error_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ†ã‚¹ãƒˆï¼ˆ3å›ä»¥ä¸Šï¼‰

### Phase 2 å®Ÿè£…é …ç›®ï¼ˆæ¬¡ã®ãƒãƒ£ãƒƒãƒˆï¼‰

- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- [ ] äºˆé˜²çš„ç›£è¦–æ©Ÿèƒ½å®Ÿè£…
- [ ] è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆå®Ÿè£…
- [ ] ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã®çµ±åˆ
- [ ] é•·æ™‚é–“é‹ç”¨ãƒ†ã‚¹ãƒˆï¼ˆ24æ™‚é–“ä»¥ä¸Šï¼‰

---

## ğŸš€ æ¬¡ã®ãƒãƒ£ãƒƒãƒˆã¸ã®å¼•ç¶™ãäº‹é …

### âœ… æœ¬ãƒãƒ£ãƒƒãƒˆã§å®Œäº†äºˆå®š

1. Phase 1ã®å¼·åŒ–ç­–å®Ÿè£…
2. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
3. å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ
4. æœ€çµ‚å¼•ç¶™æ›¸ä½œæˆ

### â³ æ¬¡ã®ãƒãƒ£ãƒƒãƒˆã§å®Ÿæ–½

1. **OCRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ã®å¼·åŒ–**
   - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šUIé–‹ç™º
   - é ˜åŸŸæŒ‡å®šã®å¯è¦–åŒ–
   - ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜æ©Ÿèƒ½

2. **DBãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ã®æœ€å°åŒ–**
   - ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«æœ€é©åŒ–
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥è¦‹ç›´ã—
   - å³æ™‚åæ˜ ãƒ¡ã‚«ãƒ‹ã‚ºãƒ å°å…¥

3. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰**
   - R2ã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   - ä¸–ä»£ç®¡ç†æ©Ÿèƒ½
   - ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾©å…ƒæ©Ÿèƒ½

4. **Phase 2ã®å¼·åŒ–ç­–å®Ÿè£…**
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
   - äºˆé˜²çš„ç›£è¦–
   - è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ

---

**END OF DOCUMENT**
