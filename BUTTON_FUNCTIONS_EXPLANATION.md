# ボタン機能の詳細説明

## 📋 案件作成ページのボタン機能

### 1️⃣ **「物件情報を自動取得」ボタン**

#### **目的**
国土交通省の**不動産情報ライブラリ（MLIT API）**から物件情報を自動取得し、フォームに自動入力する機能。

#### **機能詳細**
- **データソース**: 国土交通省 不動産情報ライブラリ API (`reinfolib.mlit.go.jp`)
- **必要な入力**: 「所在地」フィールドに住所を入力
- **取得できる情報**:
  - 土地面積
  - 用途地域
  - 建蔽率
  - 容積率
  - 道路情報（方向、種類、幅員）
  - 間口
  - 建物面積
  - 構造
  - 築年月
  - 取引価格

#### **動作フロー**:
```
1. ユーザーが「所在地」フィールドに住所を入力
   例: 「東京都板橋区蓮根三丁目17-7」
   
2. 「物件情報を自動取得」ボタンをクリック
   
3. システムが以下を実行:
   a. 住所を都道府県・市区町村コードに変換
   b. MLIT APIに現在年・現在四半期のデータをリクエスト
   c. 取得したデータをフォームフィールドに自動入力
   d. ハザード情報も同時に取得して表示
   
4. 成功時: 
   「✅ X項目を自動入力しました」とアラート表示
   
5. 失敗時:
   - 住所解析失敗 → 正しい形式で入力を促す
   - データなし → 別の住所で試すよう促す
   - API エラー → エラー詳細を表示
```

#### **実装ファイル**:
- フロントエンド: `src/index.tsx` (line 9032: `window.autoFillFromReinfolib`)
- バックエンド: `src/routes/reinfolib-api.ts` (line 400+: `/api/reinfolib/property-info`)

#### **認証**:
- `auth_token` (localStorage から取得)
- `MLIT_API_KEY` (Cloudflare環境変数、必須)

---

### 2️⃣ **「総合リスクチェック実施」ボタン**

#### **目的**
物件の住所から災害リスクや建築規制情報を取得し、融資可否を総合判定する機能。

#### **機能詳細**
- **データソース**: 
  - 国土交通省 不動産情報ライブラリ API (ハザード情報)
  - OpenStreetMap Nominatim API (ジオコーディング)
  - 自社データベース (建築規制情報)
  
- **必要な入力**: 「所在地」フィールドに住所を入力

- **チェック項目**:
  - **水害リスク**: 洪水浸水想定、想定浸水深度
  - **土砂災害リスク**: 土砂災害警戒区域、特別警戒区域（レッドゾーン）
  - **家屋倒壊等氾濫想定区域**: 河川氾濫による家屋倒壊リスク
  - **都市計画**: 用途地域、市街化区域/調整区域

#### **融資制限条件**（重要）:
以下に該当する物件は提携金融機関での融資が困難:
1. 水害による想定浸水深度が **10m以上** の区域
2. **家屋倒壊等氾濫想定区域** に該当
3. **土砂災害特別警戒区域（レッドゾーン）** に該当

#### **動作フロー**:
```
1. ユーザーが「所在地」フィールドに住所を入力
   
2. 「総合リスクチェック実施」ボタンをクリック
   
3. システムが以下を実行:
   a. 住所をジオコーディング（緯度経度に変換）
   b. 不動産情報ライブラリからハザード情報を取得
   c. 建築規制情報をチェック
   d. 融資可否を総合判定
   
4. 結果表示:
   - 住所情報（都道府県、市区町村）
   - 災害リスクレベル（高・中・低）
   - 融資判定（OK / NG / 要確認）
   - 処理時間
```

#### **実装ファイル**:
- フロントエンド: 
  - `src/index.tsx` (line 9210: `window.manualComprehensiveRiskCheck`)
  - `public/static/ocr-init.js` (line 548: `runComprehensiveRiskCheck`)
- バックエンド: `src/routes/reinfolib-api.ts` (line 908: `/api/reinfolib/comprehensive-check`)

#### **認証**:
- `auth_token` (localStorage から取得)

---

### 3️⃣ **「売主」ドロップダウン**

#### **目的**
案件の売主（AGENT ユーザー）を選択するためのドロップダウンメニュー。

#### **機能詳細**
- **データソース**: D1 Database (`users` テーブル、`role = 'AGENT'`)
- **取得方法**: `/api/auth/users` エンドポイントから全ユーザーを取得し、フロントエンドで AGENT ロールのみフィルタ

#### **動作フロー**:
```
1. 案件作成ページが読み込まれる
   
2. 500ms 遅延後、loadSellers() 関数が実行される
   
3. seller_id 要素が見つかるまで最大5回リトライ（300ms間隔）
   
4. /api/auth/users から全ユーザーを取得
   
5. role === 'AGENT' のユーザーのみフィルタ
   
6. ドロップダウンに選択肢を追加:
   「ユーザー名 (会社名)」形式で表示
   
7. 成功ログを Console に出力
```

#### **実装ファイル**:
- フロントエンド: `src/index.tsx` (line 6398: `loadSellers`)
- バックエンド: `src/routes/auth.ts` (全ユーザー取得エンドポイント)

#### **認証**:
- `auth_token` (localStorage から取得)

#### **エラーハンドリング**:
- DOM 要素が見つからない → リトライ（最大5回）
- トークンがない → Console エラーログのみ（アラート削除）
- AGENT ユーザーが0件 → Console 警告ログのみ

---

## 🐛 現在発生している問題

### **問題1: 売主ドロップダウンが空白**

**症状**: 
- ドロップダウンに選択肢が表示されない

**原因**:
- DOM 要素が存在しない時点で loadSellers() が実行されている（既に v3.153.1 で修正済み）
- ユーザーが古いデプロイメントでテストしている可能性

**修正状況**: ✅ v3.153.1 で修正済み
- リトライロジック実装（最大5回、300ms間隔）
- 初期化を500ms遅延

---

### **問題2: リスクチェックボタンのエラー**

**症状**: 
- Consoleエラー: 「CHECK failed: 住所が検出されていません」

**原因**:
- `ocr-init.js` の `runComprehensiveRiskCheck` 関数が `address` パラメータを受け取っているが、バックエンドAPIに正しく渡されていない可能性
- または、OCR抽出した住所形式が不正（例: 「浦安市東京都住宅供給...土地全部事項」）

**修正が必要**:
1. フロントエンドで住所のバリデーション追加
2. `address` パラメータが空でないことを確認
3. Console ログで実際に送信される `address` 値を確認

---

### **問題3: 物件情報を自動取得ボタンのエラー**

**症状**: 
- Console エラー: 「COMPREHENSIVE (ocr-init.js) HE CHECK) Resumes: → Object」

**原因**:
- エラーメッセージが不明瞭
- 住所フィールドの値が不正である可能性

**修正が必要**:
1. エラーハンドリングの改善
2. 住所形式のバリデーション
3. より詳細なエラーメッセージ

---

## 🔧 修正方針

### **修正1: リスクチェック機能のデバッグ強化**
```typescript
// ocr-init.js に追加
async function runComprehensiveRiskCheck(address) {
  console.log('[COMPREHENSIVE CHECK] ========================================');
  console.log('[COMPREHENSIVE CHECK] Input address:', address);
  console.log('[COMPREHENSIVE CHECK] Address type:', typeof address);
  console.log('[COMPREHENSIVE CHECK] Address length:', address ? address.length : 0);
  
  // 住所のバリデーション
  if (!address || typeof address !== 'string' || address.trim().length === 0) {
    console.error('[COMPREHENSIVE CHECK] ❌ Invalid address');
    alert('エラー: 有効な住所を入力してください');
    return;
  }
  
  const trimmedAddress = address.trim();
  console.log('[COMPREHENSIVE CHECK] Trimmed address:', trimmedAddress);
  
  // ... 以降の処理
}
```

### **修正2: 住所フィールドのバリデーション**
- OCR 抽出後、住所フィールドの値を検証
- 不正な形式（例: 「...土地全部事項」などのゴミデータ）を除去

### **修正3: エラーメッセージの改善**
- ユーザーに分かりやすいエラーメッセージ
- Console ログの構造化

---

## ✅ 次のアクション

1. ✅ **機能説明ドキュメント作成完了** ← 今ここ
2. 🔄 **リスクチェック機能のバグ修正**
3. 🔄 **物件情報自動取得機能のバグ修正**
4. 🔄 **売主ドロップダウンの最終確認**（v3.153.1デプロイメントで）
5. 🔄 **ビルド・デプロイ・本番テスト**
6. 🔄 **最終引き継ぎレポート作成**

