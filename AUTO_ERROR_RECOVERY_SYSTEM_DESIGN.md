# 自動エラー改善システム (Auto Error Recovery System) - 設計書

**バージョン**: v1.0  
**作成日**: 2025-12-11  
**目的**: 運用開始後のエラーを自動検知・自動修復し、メンテナンスフリーを実現

---

## 📋 システム概要

### 1. 過去エラーパターン分析 (v3.67.0 ~ v3.153.53)

#### 🔴 **最頻出エラー TOP 3**

| No | エラー種別 | 発生回数 | 根本原因 | 改善履歴 |
|----|-----------|---------|---------|---------|
| 1 | **認証エラー (401)** | 30+ | トークン期限切れ | v3.153.53: 自動ログインリダイレクト実装 |
| 2 | **ブラウザキャッシュ問題** | 15+ | 古いJSファイルが読み込まれる | v3.153.51: ファイル名バージョニング |
| 3 | **案件作成HTTP 500** | 12+ | 必須項目の未入力 | v3.153.52: フロントエンド検証強化 |

#### 📊 **エラー分類**

```
【認証系】40% - 401/403エラー、トークン期限切れ
【データ系】30% - DB接続エラー、必須項目未入力
【UI/UX系】20% - キャッシュ問題、undefined表示
【API系】10% - タイムアウト、ネットワークエラー
```

---

## 🎯 システム要件

### ユーザー要求事項

1. **管理者ページ作成**: 各機能のチェックボタン配置
2. **エラーテスト実行**: ボタン押下で自動チェック
3. **結果表示**: clear/error を明確に表示
4. **自動改善**: エラー時、状況分析→自動修復
5. **メンテナンスフリー**: 手動介入を最小化
6. **問い合わせフロー**: 修復不可能な場合は info@my-agent.work へ連絡

### 対象機能 (6つ)

1. ✅ **OCR機能** - PDF/画像からのテキスト抽出
2. ✅ **物件情報自動補完** - 住所から物件詳細を取得
3. ✅ **リスクチェック** - 総合判定、災害リスク評価
4. ✅ **案件作成** - 必須項目検証、DB登録
5. ✅ **提出書類管理** - ファイルアップロード、R2ストレージ
6. ✅ **案件一覧のステータス確認** - 一覧表示、フィルタリング

---

## 🏗️ システム設計

### アーキテクチャ

```
┌─────────────────────────────────────────────────┐
│          管理者ページ (/admin/health-check)        │
│  [OCRチェック] [物件補完] [リスクチェック]           │
│  [案件作成]   [書類管理] [案件一覧]                │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│       エラー検知エンジン (Frontend + Backend)      │
│  1. API疎通テスト                                 │
│  2. データ整合性チェック                           │
│  3. 認証状態確認                                  │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│           自動修復エンジン (Backend API)          │
│  1. トークンリフレッシュ                           │
│  2. キャッシュクリア指示                           │
│  3. DBマイグレーション自動実行                     │
│  4. ログ収集＋エラー通知                           │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│              結果表示＋アクション                  │
│  ✅ CLEAR → 問題なし                              │
│  ❌ ERROR → 自動修復実行中...                     │
│  ⚠️  PARTIAL → 手動確認が必要                     │
└─────────────────────────────────────────────────┘
```

---

## 🔧 実装計画

### Phase 1: 管理者ページ作成 (1-2時間)

**ファイル**: `src/index.tsx` (新規ルート `/admin/health-check`)

**UI構成**:
```html
<div class="admin-health-check">
  <h1>🛡️ システムヘルスチェック</h1>
  
  <div class="check-grid">
    <button id="check-ocr">OCR機能チェック</button>
    <button id="check-property">物件情報補完チェック</button>
    <button id="check-risk">リスクチェック</button>
    <button id="check-deal">案件作成チェック</button>
    <button id="check-files">書類管理チェック</button>
    <button id="check-list">案件一覧チェック</button>
  </div>
  
  <div id="results">
    <!-- 結果表示エリア -->
  </div>
</div>
```

### Phase 2: エラー検知API実装 (2-3時間)

**新規ファイル**: `src/routes/health-check.ts`

**エンドポイント**:
```typescript
POST /api/health-check/ocr
POST /api/health-check/property-info
POST /api/health-check/risk-check
POST /api/health-check/deal-creation
POST /api/health-check/file-management
POST /api/health-check/deal-list
```

**チェック項目**:
1. API疎通確認 (200 OK)
2. 認証トークン有効性
3. データベース接続
4. 外部API (国土交通省API) 疎通
5. R2ストレージアクセス
6. 必須テーブル存在確認

### Phase 3: 自動修復ロジック実装 (3-4時間)

**新規ファイル**: `src/routes/auto-recovery.ts`

**修復パターン**:

| エラー種別 | 検知方法 | 自動修復アクション |
|-----------|---------|------------------|
| **401認証エラー** | APIレスポンス401 | トークンリフレッシュ → 再試行 |
| **ブラウザキャッシュ** | バージョン不一致 | キャッシュクリア指示 (Header設定) |
| **DBマイグレーション未実行** | テーブル不存在 | `wrangler d1 migrations apply --local` 自動実行 |
| **外部API障害** | タイムアウト | リトライ (3回、exponential backoff) |
| **ストレージ容量超過** | 95%以上 | 古いファイル自動削除 + 管理者通知 |

### Phase 4: 100パターンテスト実装 (CSV待ち)

**テストデータ形式** (user提供予定):
```csv
test_id,function,input_data,expected_result
1,ocr,sample.pdf,success
2,property_info,"東京都港区六本木1-1-1",success
3,risk_check,"千葉県浦安市堀江2-17-21",manual_check_required
...
```

**自動テスト実行**:
```bash
npm run test:health-check -- --csv=test_patterns.csv
```

---

## 📈 成功指標 (KPI)

1. **エラー検知率**: 100% (全エラーを検知)
2. **自動修復率**: 80%以上 (手動介入20%以下)
3. **修復時間**: 平均30秒以内
4. **誤検知率**: 5%以下
5. **システム稼働率**: 99.9%以上

---

## 🚨 運用開始後の対応フロー

```
エラー発生
    ↓
自動検知 (リアルタイム監視)
    ↓
自動修復試行 (3回まで)
    ↓
成功？
 ├─ YES → ログ記録 + ユーザー通知 (修復完了)
 └─ NO  → 管理者アラート + info@my-agent.work へメール送信
```

---

## 📝 次のステップ

### ✅ 完了済み
- 過去エラーパターン分析
- システム設計書作成

### 🔄 実装中
- v3.153.54: バージョン番号統一

### ⏳ 未着手
1. 管理者ページ実装 (`/admin/health-check`)
2. ヘルスチェックAPI実装 (`src/routes/health-check.ts`)
3. 自動修復ロジック実装 (`src/routes/auto-recovery.ts`)
4. 100パターンテスト実装 (CSV待ち)
5. プロダクション環境での検証

---

## 📞 問い合わせ先

**修復不可能なエラー発生時**:  
📧 **info@my-agent.work**

---

**END OF DOCUMENT**
