# 200棟土地仕入れ管理システム - ユーザーガイド v3.153.36

**最終更新**: 2025-12-10  
**バージョン**: v3.153.36  
**本番URL**: https://9cc9794e.real-estate-200units-v2.pages.dev  
**ログイン**: navigator-187@docomo.ne.jp / kouki187 (管理者アカウント)

---

## 📋 目次

1. [システム概要](#システム概要)
2. [主要機能一覧](#主要機能一覧)
3. [OCR機能 (物件概要書の自動読み取り)](#ocr機能-物件概要書の自動読み取り)
4. [物件情報自動補完機能](#物件情報自動補完機能)
5. [総合リスクチェック機能](#総合リスクチェック機能)
6. [案件作成・管理機能](#案件作成管理機能)
7. [ファイル管理・書類保存機能](#ファイル管理書類保存機能)
8. [トップページ・ダッシュボード](#トップページダッシュボード)
9. [管理者ログイン履歴](#管理者ログイン履歴)
10. [建築基準法・条例情報表示](#建築基準法条例情報表示)
11. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

**200棟土地仕入れ管理システム**は、不動産仲介業務における土地物件の仕入れから案件管理までを一元的に支援するクラウドベースのWebアプリケーションです。

### 主な特徴

- **OCR技術による物件概要書の自動読み取り** (OpenAI GPT-4o Vision API)
- **国土交通省APIとの連携による物件情報の自動補完**
- **ハザードマップと建築基準法情報の自動取得**
- **48時間営業日ルールによる回答期限管理**
- **Cloudflare D1データベースによる高速データ管理**
- **モバイル対応のレスポンシブデザイン**

### システム要件

- **対応ブラウザ**: Chrome, Safari, Edge, Firefox (最新版)
- **推奨環境**: デスクトップPC、タブレット、スマートフォン
- **インターネット接続**: 必須

---

## 主要機能一覧

| 機能名 | 説明 | 実装状況 |
|--------|------|----------|
| **OCR機能** | 物件概要書PDFから自動で情報を抽出 | ✅ 実装済み (v3.153.34) |
| **物件情報自動補完** | 住所から国交省APIで物件情報を自動取得 | ✅ 実装済み |
| **総合リスクチェック** | ハザードマップ・建築基準法情報の自動取得 | ✅ 実装済み |
| **案件作成・管理** | 案件の登録・編集・ステータス管理 | ✅ 実装済み (v3.153.36でログ強化) |
| **48時間ルール計算** | 営業日ベースでの回答期限自動計算 | ✅ 実装済み |
| **ファイル管理** | 物件関連書類のアップロード・保存 | ✅ 実装済み |
| **トップページ** | 案件一覧・ステータスサマリー表示 | ✅ 実装済み |
| **管理者ログイン履歴** | 管理者限定でユーザーログイン履歴を確認 | ✅ 実装済み |
| **通知機能** | 新規案件登録時のメール・LINE/Slack通知 | ✅ 実装済み |

---

## OCR機能 (物件概要書の自動読み取り)

### 概要

物件概要書のPDFファイルをアップロードすると、OpenAI GPT-4o Vision APIを使用して自動的に物件情報を抽出し、入力フォームに反映します。

### 対応フォーマット

- **ファイル形式**: PDF, JPG, JPEG, PNG, WEBP
- **ファイルサイズ**: 1ファイルあたり最大10MB
- **アップロード数**: 最大10ファイルまで同時処理可能

### 抽出可能な情報

| フィールド名 | 説明 | 例 |
|-------------|------|-----|
| **物件名** | 物件の名称 | `品川区西中延2丁目` |
| **所在地** | 住所 | `東京都品川区西中延2-15-12` |
| **最寄駅** | 最寄り駅名 | `矢向` |
| **徒歩分数** | 駅からの徒歩時間 | `5` (分) |
| **土地面積** | 土地の面積 | `218.14㎡（実測）` |
| **建物面積** | 建物の延床面積 | `157.34㎡` |
| **用途地域** | 都市計画法上の用途地域 | `第一種住居地域` |
| **建ぺい率** | 建築可能な建築面積の割合 | `60%` |
| **容積率** | 建築可能な延床面積の割合 | `200%` |
| **高度地区** ⚠️ | 建物の高さ制限 | `第二種高度地区` |
| **防火地域** ⚠️ | 防火規制の種類 | `準防火地域` |
| **道路情報** | 接道状況 | `北側私道 幅員2.0m 接道2.0m` |
| **間口** ⚠️ | 道路に接する幅 | `4.14m` (※「東側 幅員4.14m」から数値のみ抽出) |
| **構造** | 建物の構造 | `木造3階建` |
| **築年数** | 建築年月 | `平成28年3月` |
| **現況** | 物件の現在の状態 | `賃貸中` |
| **利回り** | 想定利回り | `7.5%` |
| **入居状況** | 賃貸物件の入居状況 | `満室` |
| **価格** | 売却希望価格 | `14,500万円` |

⚠️ **重要な注意事項**: 
- **高度地区**、**防火地域**、**間口**は **v3.153.34** で修正済みですが、OCR APIが正しく抽出するかは実際のテストで確認が必要です。
- **間口**の抽出プロンプトは改善されており、「東側 幅員4.14m」のような詳細情報ではなく「4.14m」のみを抽出するように設定されています。

### 使用方法

#### ステップ1: 案件作成ページへ移動

1. システムにログイン
2. 左上のメニューから「案件作成」をクリック
3. または、トップページの「新規案件作成」ボタンをクリック

#### ステップ2: OCRファイルアップロード

**方法1: ドラッグ&ドロップ**
1. ページ上部の「物件概要書をドラッグ＆ドロップ」エリアにファイルをドラッグ
2. ファイルをドロップすると自動的にOCR処理が開始

**方法2: ファイル選択**
1. 「ファイルを選択」ボタンをクリック
2. エクスプローラー/ファインダーから物件概要書を選択
3. 「開く」をクリックすると自動的にOCR処理が開始

#### ステップ3: OCR処理の確認

1. アップロード後、**プログレスバー**が表示され、処理の進捗状況を確認できます
2. 処理が完了すると、抽出された情報が自動的に入力フォームに反映されます
3. ブラウザのコンソールログ (F12キー → Console) で詳細を確認できます:
   ```
   [OCR] FULL extracted_data: { ... }
   [OCR] Set height_district: 第二種高度地区
   [OCR] Set fire_zone: 準防火地域
   [OCR] Set frontage: 4.14m
   ```

#### ステップ4: 手動修正

1. OCRで抽出された情報を確認
2. 必要に応じて手動で修正・追加入力
3. 特に以下のフィールドは注意して確認してください:
   - **高度地区** (例: 第一種、第二種、第三種、第四種)
   - **防火地域** (例: 防火地域、準防火地域、無指定)
   - **間口** (数値と単位のみ。例: 4.14m)

### トラブルシューティング

#### 問題1: OCRが起動しない

**原因**: ファイルサイズが大きすぎる、または対応していない形式

**対処法**:
- ファイルサイズを10MB以下に圧縮
- PDF, JPG, PNG, WEBP形式のみ対応

#### 問題2: 高度地区・防火地域が空白

**原因1**: OCR APIが抽出に失敗

**対処法**:
1. ブラウザのコンソールログ (F12) を開く
2. `[OCR] FULL extracted_data:`を探す
3. `height_district`と`fire_zone`が含まれているか確認
4. 含まれていない場合、手動で入力

**原因2**: PDFの画質が悪い

**対処法**:
- 高解像度のスキャンまたはスクリーンショットを使用
- 文字がはっきり読めるファイルを使用

#### 問題3: 間口が「東側 幅員4.14m」のまま

**原因**: OCRプロンプトが期待通りに動作していない

**対処法**:
1. 手動で「4.14m」に修正
2. 次回のシステム更新時に報告

---

## 物件情報自動補完機能

### 概要

**国土交通省の不動産情報ライブラリAPI** (Reinfolib) と連携し、住所を入力するだけで自動的に詳細な物件情報を取得します。

### 自動取得される情報

- 土地面積
- 建物面積
- 用途地域
- 建ぺい率
- 容積率
- 最寄駅
- 駅からの徒歩分数

### 使用方法

#### ステップ1: 住所を入力

1. 案件作成ページの「所在地」フィールドに住所を入力
   - 例: `東京都品川区西中延2-15-12`
2. 住所は**都道府県から番地まで**正確に入力してください

#### ステップ2: 自動補完ボタンをクリック

1. 「物件情報自動補完」ボタンをクリック
2. 処理中はボタンが無効化され、「取得中...」と表示されます
3. 数秒で結果が返されます

#### ステップ3: 取得結果の確認

1. 成功すると、以下のフィールドが自動的に入力されます:
   - 土地面積
   - 建物面積
   - 用途地域
   - 建ぺい率
   - 容積率
   - 最寄駅
   - 徒歩分数
2. 既に入力されているフィールドは**上書きされます**
3. 取得できなかった項目は空白のままです

### トラブルシューティング

#### 問題: 自動補完が失敗する

**原因1**: 住所が不正確

**対処法**:
- 都道府県、市区町村、町名、番地を全て正確に入力
- 例: `東京都品川区西中延2-15-12` (○)
- 例: `品川区西中延2-15-12` (×)

**原因2**: 国交省APIに該当データがない

**対処法**:
- 手動で入力
- 別の情報源 (不動産ポータルサイト、登記情報など) を参照

---

## 総合リスクチェック機能

### 概要

住所を入力すると、以下の情報を自動的に取得し、リスク評価を行います:

1. **ハザードマップ情報** (洪水、土砂災害、津波など)
2. **建築基準法情報** (用途地域、建ぺい率、容積率、高度地区、防火地域)
3. **周辺施設情報** (学校、病院、商業施設など)

### 取得される情報

| カテゴリ | 取得項目 | 情報源 |
|---------|---------|--------|
| **ハザードマップ** | 洪水浸水想定区域、土砂災害警戒区域、津波浸水想定区域 | 国土交通省ハザードマップポータルサイト |
| **建築基準法** | 用途地域、建ぺい率、容積率、高度地区、防火地域、道路幅員 | 国土交通省不動産情報ライブラリ |
| **周辺施設** | 最寄駅、学校、病院、スーパー、コンビニ | Googleマップ API (将来実装予定) |

### 使用方法

#### ステップ1: 住所を入力

1. 案件作成ページの「所在地」フィールドに住所を入力
   - 例: `東京都品川区西中延2-15-12`

#### ステップ2: リスクチェックボタンをクリック

1. 「総合リスクチェック実施」ボタンをクリック
2. 処理中はボタンが無効化され、「チェック中...」と表示されます
3. 10-20秒程度で結果が返されます

#### ステップ3: 結果の確認

1. リスクチェック結果が**モーダルウィンドウ**で表示されます
2. 以下のセクションで構成されています:
   - **ハザードマップ情報**: リスクレベル (高・中・低) と詳細
   - **建築基準法情報**: 用途地域、建ぺい率、容積率、高度地区、防火地域
   - **総合評価**: リスクの総合判定とコメント
3. 結果は自動的にデータベースに保存されます

#### ステップ4: PDFレポート出力 (将来実装予定)

- リスクチェック結果をPDFでダウンロード可能 (開発中)

### トラブルシューティング

#### 問題: リスクチェックが失敗する

**原因1**: 住所が不正確

**対処法**:
- 都道府県、市区町村、町名、番地を全て正確に入力

**原因2**: APIレート制限

**対処法**:
- 数分待ってから再度実行

**原因3**: 対象地域が未対応

**対処法**:
- 手動でハザードマップポータルサイトを確認
- https://disaportal.gsi.go.jp/

---

## 案件作成・管理機能

### 概要

物件の仕入れ案件を登録・管理し、ステータス変更や情報更新を行います。

### 案件ステータス

| ステータス | 説明 | 色 |
|-----------|------|-----|
| **NEW** | 新規案件 (48時間以内に回答必要) | 🔴 赤 |
| **ANSWERED** | 回答済み (売主が回答した) | 🟡 黄 |
| **COMPLETED** | 完了 (契約成立または案件終了) | 🟢 緑 |
| **期限切れ** | 48時間以内に回答がなかった | ⚫ グレー |

### 48時間営業日ルール

- **営業日**: 月曜日〜金曜日 (土日祝日を除く)
- **計算方法**: 案件作成時刻から48時間の営業時間をカウント
- **例**:
  - 月曜日 10:00 作成 → 水曜日 10:00 が期限
  - 金曜日 17:00 作成 → 火曜日 17:00 が期限 (土日を除外)

### 使用方法

#### 案件作成

1. トップページまたはメニューから「案件作成」をクリック
2. **必須フィールド** (初回6情報) を入力:
   - 案件タイトル
   - 所在地
   - 最寄駅
   - 土地面積
   - 用途地域
   - 希望価格
3. 必要に応じてOCR、自動補完、リスクチェックを実行
4. 「保存して案件作成」ボタンをクリック

#### 案件編集

1. トップページの案件一覧から編集したい案件をクリック
2. 案件詳細ページで「編集」ボタンをクリック
3. 必要な情報を修正
4. 「更新」ボタンをクリック

#### ステータス変更

1. 案件詳細ページで「ステータス変更」ボタンをクリック
2. ドロップダウンから新しいステータスを選択:
   - **NEW**: 新規案件
   - **ANSWERED**: 回答済み
   - **COMPLETED**: 完了
3. 「保存」をクリック

### トラブルシューティング

#### 問題: 案件作成ボタンで HTTP 500 エラー

**原因**: 複数の可能性があります (v3.153.36で詳細ログ追加済み)

**対処法 (第1回調査)**:
1. ブラウザのコンソールログ (F12) を開く
2. 以下のログを探す:
   ```
   [CREATE DEAL] Starting deal creation
   [CREATE DEAL] User ID: admin-001
   [CREATE DEAL] Request body keys: [...]
   ```
3. もしエラーログが表示されている場合:
   ```
   ❌ [CREATE DEAL ERROR] Critical error occurred: ...
   [CREATE DEAL ERROR] Error message: ...
   ```
4. エラーメッセージをコピーして管理者に報告

**対処法 (第2回調査)**:
1. ネットワークタブ (F12 → Network) を開く
2. `POST /api/deals` リクエストを探す
3. レスポンスタブで詳細なエラー情報を確認:
   ```json
   {
     "error": "Internal server error",
     "message": "...",
     "type": "..."
   }
   ```
4. この情報を管理者に報告

**対処法 (第3回調査 - 最後の手段)**:
1. 全ての必須フィールドが入力されているか再確認
2. 特に「売主」が選択されているか確認
3. ブラウザのキャッシュをクリア (Shift + F5)
4. 別のブラウザで試す

---

## ファイル管理・書類保存機能

### 概要

案件に関連する書類 (物件概要書、登記情報、契約書など) をアップロード・保存します。

### 対応ファイル形式

- **PDF**: 物件概要書、登記情報、契約書
- **画像**: JPG, JPEG, PNG, WEBP
- **最大サイズ**: 1ファイルあたり10MB
- **保存先**: Cloudflare R2 ストレージ (将来実装予定)

### 使用方法

#### ファイルアップロード

1. 案件詳細ページで「ファイル管理」タブをクリック
2. 「ファイルをアップロード」ボタンをクリック
3. ファイルを選択
4. 「アップロード」をクリック

#### ファイル閲覧

1. 案件詳細ページの「ファイル管理」タブ
2. ファイル一覧からダウンロードしたいファイルをクリック
3. ブラウザで開くか、ダウンロードが開始されます

#### ファイル削除

1. 案件詳細ページの「ファイル管理」タブ
2. 削除したいファイルの「削除」ボタンをクリック
3. 確認ダイアログで「削除」をクリック

### トラブルシューティング

#### 問題: ファイルアップロードが失敗する

**原因1**: ファイルサイズが大きすぎる

**対処法**:
- ファイルを10MB以下に圧縮
- PDFの場合、解像度を下げる

**原因2**: 対応していない形式

**対処法**:
- PDF, JPG, PNG, WEBPのみ対応
- 他の形式の場合、変換ツールを使用

---

## トップページ・ダッシュボード

### 概要

案件の一覧表示、ステータスサマリー、検索・フィルター機能を提供します。

### 表示内容

#### ステータスサマリー

- **新規案件**: 48時間以内に回答が必要な案件数
- **回答済み**: 売主が回答した案件数
- **完了**: 契約成立または終了した案件数
- **期限切れ**: 48時間以内に回答がなかった案件数

#### 案件一覧

| カラム | 説明 |
|--------|------|
| **案件タイトル** | 物件名または住所 |
| **所在地** | 物件の住所 |
| **希望価格** | 売却希望価格 |
| **ステータス** | NEW / ANSWERED / COMPLETED |
| **回答期限** | 48時間ルールで計算された期限 |
| **作成日時** | 案件が登録された日時 |

### 使用方法

#### 案件検索

1. トップページの検索バーに以下を入力:
   - 住所
   - 物件名
   - 案件ID
2. エンターキーまたは検索ボタンをクリック

#### フィルター

1. ステータスでフィルター:
   - 「新規案件のみ」
   - 「回答済みのみ」
   - 「完了のみ」
2. 日付範囲でフィルター:
   - 作成日
   - 回答期限

#### ソート

1. カラムヘッダーをクリックして昇順/降順を切り替え
2. デフォルト: 作成日時の降順 (新しい順)

---

## 管理者ログイン履歴

### 概要

管理者ユーザーのみがアクセスできる機能で、全ユーザーのログイン履歴を確認できます。

### 表示内容

| カラム | 説明 |
|--------|------|
| **ユーザー名** | ログインしたユーザーの名前 |
| **メールアドレス** | ログインしたユーザーのメール |
| **ロール** | ADMIN / AGENT |
| **ログイン日時** | ログインした日時 |
| **IPアドレス** | ログイン元のIPアドレス |
| **ユーザーエージェント** | 使用ブラウザ情報 |

### 使用方法

#### アクセス方法

1. 管理者アカウントでログイン
2. 左上のメニューから「ログイン履歴」をクリック
3. 履歴一覧が表示されます

#### 検索・フィルター

1. ユーザー名またはメールアドレスで検索
2. 日付範囲でフィルター
3. ロールでフィルター (ADMIN / AGENT)

### 注意事項

- **一般ユーザー (AGENT) はアクセスできません**
- ログイン履歴は最大90日間保存されます
- セキュリティ上の理由で、パスワード情報は記録されません

---

## 建築基準法・条例情報表示

### 概要

リスクチェック実行時に、物件の建築基準法および地方自治体の条例情報を自動的に取得・表示します。

### 表示される情報

| 項目 | 説明 |
|------|------|
| **用途地域** | 都市計画法上の用途地域 (第一種住居地域など) |
| **建ぺい率** | 建築可能な建築面積の割合 (例: 60%) |
| **容積率** | 建築可能な延床面積の割合 (例: 200%) |
| **高度地区** | 建物の高さ制限 (第一種、第二種、第三種など) |
| **防火地域** | 防火規制の種類 (防火地域、準防火地域、無指定) |
| **道路幅員** | 接道している道路の幅 (例: 4.14m) |
| **建築基準法22条区域** | 屋根や外壁の防火性能に関する規制 |

### 使用方法

1. 案件作成ページで「総合リスクチェック実施」をクリック
2. リスクチェック結果のモーダルで「建築基準法情報」タブをクリック
3. 詳細情報が表示されます

### トラブルシューティング

#### 問題: 建築基準法情報が表示されない

**原因**: 国交省APIに該当データがない

**対処法**:
- 自治体の都市計画情報サイトを直接確認
- 建築指導課に問い合わせ

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. ログインできない

**原因**: パスワードが間違っている

**対処法**:
- パスワードを再確認 (大文字・小文字を区別)
- パスワードリセット機能を使用 (実装予定)
- 管理者に連絡

#### 2. OCRが遅い

**原因**: ファイルサイズが大きい、またはサーバーが混雑

**対処法**:
- ファイルを圧縮して再アップロード
- 時間を置いて再試行

#### 3. 自動補完が失敗する

**原因**: 住所が不正確、またはAPIにデータがない

**対処法**:
- 住所を正確に入力
- 手動で入力

#### 4. リスクチェックが失敗する

**原因**: 住所が不正確、またはAPIレート制限

**対処法**:
- 住所を正確に入力
- 数分待ってから再試行

#### 5. 案件作成でHTTP 500エラー

**原因**: 複数の可能性 (v3.153.36で詳細ログ追加)

**対処法**:
- コンソールログとネットワークタブを確認
- 詳細なエラー情報を管理者に報告
- [案件作成・管理機能のトラブルシューティング](#トラブルシューティング-3) を参照

---

## サポート情報

### お問い合わせ

- **メール**: support@example.com (仮)
- **電話**: 03-XXXX-XXXX (仮)
- **営業時間**: 平日 9:00-18:00

### システム管理者

- **担当者**: システム管理チーム
- **メール**: admin@example.com (仮)

---

## バージョン履歴

| バージョン | 日付 | 主な変更内容 |
|-----------|------|-------------|
| v3.153.36 | 2025-12-10 | 包括的なエラーログ追加 (案件作成API) |
| v3.153.35 | 2025-12-10 | OCR-init.js バージョン統一 |
| v3.153.34 | 2025-12-10 | 静的ファイルキャッシュバスティング (ファイル名変更) |
| v3.153.29 | 2025-12-10 | 高度地区・防火地域フィールドマッピング追加、間口抽出改善 |

---

**このドキュメントは v3.153.36 時点の情報です。システムのアップデートにより、機能や画面が変更される場合があります。**
