# v3.153.6 テストガイド - 自動物件情報取得・リスクチェック機能

## 🎯 デプロイ情報

- **プロダクションURL**: https://c363a668.real-estate-200units-v2.pages.dev
- **バージョン**: v3.153.6
- **デプロイ日時**: 2025-12-08
- **ログイン情報**: `navigator-187@docomo.ne.jp` / `kouki187`

---

## 📋 今回の主要な改善内容

### 1. **厳格な住所バリデーション実装** (CRITICAL FIX)

**以前の問題**:
- OCRで不完全な住所(例: "浦安市東京都住宅供給...")が抽出されても自動実行され、エラーダイアログが表示された

**今回の改善**:
```javascript
// 住所の妥当性チェック（都道府県名を含むか確認）
const prefectures = ['北海道', '青森', '岩手', ..., '沖縄'];

const hasPrefecture = prefectures.some(pref => 
  locationValue.includes(pref + '都') || 
  locationValue.includes(pref + '府') || 
  locationValue.includes(pref + '県') ||
  locationValue.includes('北海道')
);

const hasCity = locationValue.includes('市') || 
               locationValue.includes('区') || 
               locationValue.includes('町') || 
               locationValue.includes('村');

const isValidAddress = locationValue && 
                     locationValue.length >= 8 && 
                     hasPrefecture && 
                     hasCity;
```

**バリデーション条件**:
- ✅ 都道府県名が含まれている
- ✅ 市区町村名が含まれている
- ✅ 文字列長が8文字以上

**例**:
- ✅ OK: "東京都板橋区蓮根三丁目17-7" → 自動実行される
- ✅ OK: "千葉県浦安市堀江２丁目３６７－２" → 自動実行される
- ❌ NG: "浦安市東京都住宅供給..." → 自動実行スキップ(consoleログのみ)
- ❌ NG: "東京都板橋区" → 短すぎる、自動実行スキップ

---

## 🧪 テスト手順

### **事前準備**

1. ブラウザで以下URLにアクセス:
   ```
   https://c363a668.real-estate-200units-v2.pages.dev
   ```

2. **キャッシュクリア** (重要!)
   - Windows/Linux: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

3. **デベロッパーツールを開く**
   - Windows/Linux: `F12` または `Ctrl + Shift + I`
   - Mac: `Cmd + Option + I`
   - Consoleタブを開いておく

4. ログイン:
   - Email: `navigator-187@docomo.ne.jp`
   - Password: `kouki187`

---

### **テスト 1: セラードロップダウンの表示確認**

1. ログイン後、「新規物件登録」をクリック
2. フォーム内の「担当者」ドロップダウンを確認

**期待される結果**:
- ✅ 4人のAGENTユーザーが表示される:
  - 本番テスト担当者 (本番テスト不動産)
  - テスト担当者 (不動産仲介株式会社)
  - 田中太郎 (不動産ABC株式会社)
  - 佐藤花子 (株式会社XYZ不動産)

**Console ログ確認**:
```
[Seller Dropdown] Successfully loaded 4 agents
```

---

### **テスト 2: OCR + 自動物件情報取得 + 自動リスクチェック (完全な住所)**

1. 「新規物件登録」ページで、「OCRで登記簿から入力」ボタンをクリック
2. PDFファイルをアップロード: `浦安市堀江２丁目３６７－２不動産登記（土地全部事項）2025112101245116.PDF`
3. OCR処理が完了するまで待つ

**期待される動作**:
1. **OCR処理が100%まで進む**
2. **住所バリデーションが実行される**
   ```
   [OCR] Extracted location: 千葉県浦安市堀江２丁目３６７－２
   [OCR] Address validation: {
     length: 21,
     hasPrefecture: true,
     hasCity: true,
     isValid: true
   }
   [OCR] ✅ Valid location found, starting automatic processes...
   ```

3. **Step 1: 物件情報自動取得が実行される**
   ```
   [OCR] Step 1: Fetching property info from MLIT API...
   [Auto Property Info] Starting automatic property info fetch...
   [Auto Property Info] Address: 千葉県浦安市堀江２丁目３６７－２
   [Auto Property Info] API response received
   [Auto Property Info] ✅ Successfully auto-filled 8 fields
   ```

4. **Step 2: 総合リスクチェックが実行される**
   ```
   [OCR] Step 2: Running comprehensive risk check...
   [Auto Risk Check] Starting automatic risk check...
   [Auto Risk Check] Address: 千葉県浦安市堀江２丁目３６７－２
   [Auto Risk Check] API response received
   [Auto Risk Check] ✅ Risk check completed
   [Auto Risk Check] Prefecture: 千葉県
   [Auto Risk Check] City: 浦安市
   ```

5. **最終完了メッセージ**
   ```
   [OCR] ✅ All automatic processes completed successfully
   ```

6. **アラート表示**: 「OCR処理が完了しました！1個のファイルから抽出されたデータがフォームに反映されました。内容をご確認のうえ、保存してください。」

**期待される結果**:
- ✅ **エラーダイアログは一切表示されない**
- ✅ フォームに以下の項目が自動入力される:
  - 所在地: `千葉県浦安市堀江２丁目３６７－２`
  - 土地面積
  - 用途地域
  - 建蔽率
  - 容積率
  - 道路情報
  - 構造
  - 築年月
  - 取引価格

---

### **テスト 3: OCR + 不完全な住所でのスキップ動作**

1. 「新規物件登録」ページで、「OCRで登記簿から入力」ボタンをクリック
2. 不完全な住所を含む画像ファイルをアップロード: `GrandSoleil紹介資料0911.jpg`
3. OCR処理が完了するまで待つ

**期待される動作**:
1. **OCR処理が100%まで進む**
2. **住所バリデーションでNGと判定される**
   ```
   [OCR] Extracted location: 浦安市東京都住宅供給...
   [OCR] Address validation: {
     length: 15,
     hasPrefecture: false,  // ❌
     hasCity: true,
     isValid: false  // ❌
   }
   [OCR] ⚠️ No valid location extracted, skipping automatic processes
   [OCR] User can manually use buttons if needed
   ```

3. **自動実行はスキップされる**
   - `autoFetchPropertyInfo()` は実行されない
   - `autoRunRiskCheck()` は実行されない

4. **アラート表示**: 「OCR処理が完了しました！1個のファイルから抽出されたデータがフォームに反映されました。内容をご確認のうえ、保存してください。」

**期待される結果**:
- ✅ **エラーダイアログは一切表示されない**
- ✅ OCR処理は成功として扱われる
- ✅ ユーザーは手動で「物件情報を自動取得」ボタンと「総合リスクチェック実施」ボタンをクリックできる

---

### **テスト 4: 手動ボタンの動作確認**

1. フォームの「所在地」フィールドに完全な住所を入力:
   ```
   東京都板橋区蓮根三丁目17-7
   ```

2. **「物件情報を自動取得」ボタンをクリック**

**期待される動作**:
```
[不動産情報ライブラリ] Auto-fill function called
[不動産情報ライブラリ] Using address: 東京都板橋区蓮根三丁目17-7
[不動産情報ライブラリ] ✅ 379件のデータを取得しました
```

**期待される結果**:
- ✅ フォームに物件情報が入力される
- ✅ アラート表示なし (または成功メッセージのみ)

3. **「総合リスクチェック実施」ボタンをクリック**

**期待される動作**:
```
[COMPREHENSIVE CHECK] Address: 東京都板橋区蓮根三丁目17-7
[COMPREHENSIVE CHECK] ✅ Check completed
```

**期待される結果**:
- ✅ 総合判定結果がアラートで表示される
- ✅ 災害リスク情報が表示される

---

## 🐛 想定されるエラーケース

### **ケース 1: トークン切れ**

**Console ログ**:
```
[Auto Property Info] ⚠️ No auth token, skipping
[Auto Risk Check] ⚠️ No auth token, skipping
```

**対処法**: 再ログインしてください

---

### **ケース 2: API エラー (400 Bad Request)**

**Console ログ**:
```
[Auto Property Info] ⚠️ API returned error: 住所が正しくありません
```

**対処法**: 住所を修正して手動でボタンをクリックしてください

---

### **ケース 3: ネットワークエラー**

**Console ログ**:
```
[OCR] ⚠️ Automatic process error (non-critical): Network Error
```

**対処法**: インターネット接続を確認してください

---

## ✅ 成功基準

以下の条件を**すべて満たす**必要があります:

1. ✅ セラードロップダウンに4人のAGENTが表示される
2. ✅ OCR処理が正常に完了する
3. ✅ **完全な住所の場合、自動的に物件情報取得とリスクチェックが実行される**
4. ✅ **不完全な住所の場合、自動実行はスキップされ、エラーダイアログは表示されない**
5. ✅ 手動ボタン(「物件情報を自動取得」「総合リスクチェック実施」)が正常に動作する
6. ✅ **いかなる場合もエラーダイアログ(alert)は表示されない** (Console ログのみ)

---

## 📸 スクリーンショット提出内容

テスト完了後、以下のスクリーンショットを提出してください:

1. **セラードロップダウンの表示**
2. **OCR処理完了後のConsoleログ全体** (住所バリデーション部分を含む)
3. **フォームに自動入力された物件情報**
4. **エラーが発生した場合のConsoleログ**

---

## 🔧 トラブルシューティング

### **問題: OCR後にエラーダイアログが表示される**

**原因**: 
- 古いデプロイバージョンをキャッシュしている可能性があります

**解決策**:
1. ブラウザのキャッシュをクリア (`Ctrl + Shift + R`)
2. URLが正しいか確認: `https://c363a668.real-estate-200units-v2.pages.dev`
3. Consoleログでバージョンを確認
4. それでも問題が続く場合は、シークレットモードでテストしてください

---

### **問題: 自動実行が動作しない**

**確認事項**:
1. Console ログで住所バリデーション結果を確認
   ```
   [OCR] Address validation: { ..., isValid: true/false }
   ```
2. `isValid: false` の場合、住所が不完全な可能性があります
3. 手動で完全な住所を入力して「物件情報を自動取得」ボタンをクリックしてください

---

## 📊 バックエンドAPI動作確認

以下のコマンドで、バックエンドAPIが正常に動作していることを確認できます:

```bash
# ヘルスチェック
curl https://c363a668.real-estate-200units-v2.pages.dev/api/health

# プロパティ情報取得API
curl "https://c363a668.real-estate-200units-v2.pages.dev/api/reinfolib/property-info?address=東京都板橋区蓮根三丁目17-7&year=2024&quarter=4" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 総合リスクチェックAPI
curl "https://c363a668.real-estate-200units-v2.pages.dev/api/reinfolib/comprehensive-check?address=東京都板橋区蓮根三丁目17-7" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 🎓 まとめ

今回のv3.153.6では、**厳格な住所バリデーション**を実装し、不完全な住所での自動実行を防止しました。

**重要な変更点**:
1. 都道府県名 + 市区町村名の両方が含まれる住所のみ自動実行
2. 不完全な住所の場合、エラーダイアログを表示せずにスキップ
3. ユーザーは常に手動ボタンで物件情報取得とリスクチェックを実行可能

この改善により、**査定業務の効率化**と**ユーザーエクスペリエンスの向上**を両立しました。

---

**次のChat引き継ぎ事項**:
- ユーザーからのブラウザテスト結果報告を待つ
- 問題が発生した場合は、Consoleログを確認して根本原因を特定
- 必要に応じてさらなる改善を実施
